zabbix_export:
  version: "7.4"
  template_groups:
    - uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    - uuid: 4f91a8b70d3343aabf9e8d14c32eaf7d
      template: "Docker by Active Agent"
      name: "Docker by Zabbix Active Agent 2"
      description: |
        Docker monitoring via Zabbix Active Agent 2.

        Requirements:
        - Zabbix Agent 2 with Docker plugin enabled
        - Agent configured as Active mode (ServerActive parameter)
        - No agent interface required in Zabbix

        Installation:
        1. Import this template
        2. Create host with name matching agent's Hostname or HostnameItem value
        3. DO NOT add any interface to the host
        4. Link this template to the host

        Macros:
        - {$DOCKER.LLD.FILTER.CONTAINER.MATCHES}: Container name filter (regex). Default: .*
        - {$DOCKER.LLD.FILTER.CONTAINER.NOT_MATCHES}: Exclude containers (regex). Default: CHANGE_IF_NEEDED
        - {$DOCKER.CONTAINERS.STOPPED.MAX.WARN}: Maximum number of stopped containers before warning. Default: 1
        - {$DOCKER.CONTAINERS.STOPPED.MAX.CRIT}: Critical threshold for stopped containers. Default: 20
      vendor:
        name: Adrian Schmolzi
        version: 1.0-q0
      groups:
        - name: Templates/Applications
      items:
        - uuid: 1d77b27beba04822a67bdedac22ec524
          name: "Docker: Get info"
          type: ZABBIX_ACTIVE
          key: docker.info
          history: "0"
          value_type: TEXT
          description: "Docker engine information (active check)"
          tags:
            - tag: component
              value: raw
        - uuid: 3c8f26e4b80f4356bde061ccddb95f3e
          name: "Docker: Ping"
          type: ZABBIX_ACTIVE
          key: docker.ping
          valuemap:
            name: "Service state"
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 10m
          tags:
            - tag: component
              value: health
          triggers:
            - uuid: a4f00b4d25b54acfa61475c94651d8aa
              expression: "last(/Docker by Active Agent/docker.ping)=0"
              name: "Docker: Service is down"
              priority: HIGH
              manual_close: "YES"
              tags:
                - tag: scope
                  value: availability
        - uuid: 812a6b9902a44dd7a803c7218555afe9
          name: "Docker: Host name"
          type: DEPENDENT
          key: docker.name
          delay: "0"
          value_type: CHAR
          history: 1h
          master_item:
            key: docker.info
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.Name
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          tags:
            - tag: component
              value: system
          #triggers:
          #  - uuid: 2c62bb4d95684e6984447027d117ff50
          #    name: "Docker: No data received for 30m"
          #    event_name: "Docker: No data received for 30m"
          #    expression: "nodata(/Docker by Active Agent/docker.name,30m)=1"
          #    priority: WARNING
          #    manual_close: "YES"
          #    description: "Active agent has not sent data for 30 minutes."
          #    dependencies:
          #      - name: "Docker: Service is down"
          #        expression: "last(/Docker by Active Agent/docker.ping)=0"
          #    tags:
          #      - tag: scope
          #        value: availability
        - uuid: a7e5441fe4d64848a7c5e374ea99ad56
          name: "Docker: Server version"
          type: DEPENDENT
          key: docker.info.server_version
          delay: "0"
          history: 31d
          value_type: CHAR
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.ServerVersion
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: docker.info
          tags:
            - tag: component
              value: application
        - uuid: 0018bfa88b1242f7b4fe6c3b2bbb3b9e
          name: "Docker: Containers total"
          type: DEPENDENT
          key: docker.containers.total
          delay: "0"
          description: "Total number of containers on this host."
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.Containers
          master_item:
            key: docker.info
          tags:
            - tag: component
              value: containers
        - uuid: 0544be6f85f7491387ab662ebbb0ed05
          name: "Docker: Containers running"
          type: DEPENDENT
          key: docker.containers.running
          delay: "0"
          description: "Total number of containers running on this host."
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.ContainersRunning
          master_item:
            key: docker.info
          tags:
            - tag: component
              value: containers
        - uuid: 003c476e9bd94f43a59ef9cfd98e9d9f
          name: "Docker: Containers paused"
          type: DEPENDENT
          key: docker.containers.paused
          delay: "0"
          description: "Total number of containers paused on this host."
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.ContainersPaused
          master_item:
            key: docker.info
          tags:
            - tag: component
              value: containers
        - uuid: fa51584eb99b4e3482338391223ee070
          name: "Docker: Containers stopped"
          type: DEPENDENT
          key: docker.containers.stopped
          delay: "0"
          description: "Total number of containers stopped on this host."
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.ContainersStopped
          master_item:
            key: docker.info
          tags:
            - tag: component
              value: containers
          triggers:
            - uuid: 6c93e7d2e2a448f0b7e1d4b29b4e57f8
              expression: "last(/Docker by Active Agent/docker.containers.stopped)>{$DOCKER.CONTAINERS.STOPPED.MAX.WARN}"
              name: "Docker: Too many stopped containers"
              opdata: "Stopped containers: {ITEM.LASTVALUE1}"
              priority: WARNING
              description: "Number of stopped containers exceeds threshold. Consider cleaning up stopped containers."
              manual_close: "YES"
              tags:
                - tag: scope
                  value: capacity
            - uuid: d2a4b6e3a18d4c9b82f7c0a5e1b394fd
              expression: "last(/Docker by Active Agent/docker.containers.stopped)>{$DOCKER.CONTAINERS.STOPPED.MAX.CRIT}"
              name: "Docker: Critical number of stopped containers"
              opdata: "Stopped containers: {ITEM.LASTVALUE1}"
              priority: HIGH
              description: "Number of stopped containers is critically high. Immediate cleanup recommended."
              manual_close: "YES"
              tags:
                - tag: scope
                  value: capacity
            - uuid: 4f1e7b2c8c2341e0a3b6d7f9e5c2a1d0
              expression: "change(/Docker by Active Agent/docker.containers.stopped)>0"
              name: "Docker: Stopped containers count increased"
              opdata: "Stopped containers: {ITEM.LASTVALUE1}"
              priority: INFO
              description: "New container(s) have been stopped."
              manual_close: "YES"
              tags:
                - tag: scope
                  value: notice
      discovery_rules:
        - uuid: 6f379dce9d3440018deb2c2cbaa91c08
          name: "Docker: Containers discovery"
          type: ZABBIX_ACTIVE
          key: "docker.containers.discovery[false]"
          delay: 15m
          filter:
            evaltype: AND
            conditions:
              - macro: "{#NAME}"
                value: "{$DOCKER.LLD.FILTER.CONTAINER.MATCHES}"
              - macro: "{#NAME}"
                value: "{$DOCKER.LLD.FILTER.CONTAINER.NOT_MATCHES}"
                operator: NOT_MATCHES_REGEX
          description: "Active discovery of running Docker containers"
          item_prototypes:
            - uuid: 743e2c9545de49c89472e343bf8d38dc
              name: "Container {#NAME}: Get info"
              type: ZABBIX_ACTIVE
              key: 'docker.container_info["{#NAME}"]'
              history: "0"
              value_type: TEXT
              tags:
                - tag: component
                  value: raw
                - tag: container
                  value: "{#NAME}"
            - uuid: 6d8d5a7523f64968b72f4861e9ae867c
              name: "Container {#NAME}: Running"
              type: DEPENDENT
              key: 'docker.container_info.state.running["{#NAME}"]'
              delay: "0"
              valuemap:
                name: "Docker flag"
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.State.Running
                - type: BOOL_TO_DECIMAL
              master_item:
                key: 'docker.container_info["{#NAME}"]'
              tags:
                - tag: component
                  value: system
                - tag: container
                  value: "{#NAME}"
            - uuid: c7f1d81836d54a528184c7d4be60b794
              name: "Container {#NAME}: Status"
              type: DEPENDENT
              key: 'docker.container_info.state.status["{#NAME}"]'
              delay: "0"
              value_type: CHAR
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.State.Status
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1h
              master_item:
                key: 'docker.container_info["{#NAME}"]'
              tags:
                - tag: component
                  value: system
                - tag: container
                  value: "{#NAME}"
            - uuid: 4192b5b8be2545568637b7121c1466c3
              name: "Container {#NAME}: Get stats"
              type: ZABBIX_ACTIVE
              key: 'docker.container_stats["{#NAME}"]'
              history: "0"
              value_type: TEXT
              tags:
                - tag: component
                  value: raw
                - tag: container
                  value: "{#NAME}"
            - uuid: d54b82d76c7b44ca8995486e4bf46300
              name: "Container {#NAME}: CPU usage %"
              type: DEPENDENT
              key: 'docker.container_stats.cpu_usage["{#NAME}"]'
              delay: "0"
              value_type: FLOAT
              units: "%"
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.cpu_stats.cpu_usage.percent_usage
              master_item:
                key: 'docker.container_stats["{#NAME}"]'
              tags:
                - tag: component
                  value: cpu
                - tag: container
                  value: "{#NAME}"
            - uuid: 6f39422b278b4a4398bfbd993f247fd2
              name: "Container {#NAME}: Memory usage"
              type: DEPENDENT
              key: 'docker.container_stats.memory.usage["{#NAME}"]'
              delay: "0"
              units: B
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.memory_stats.usage
              master_item:
                key: 'docker.container_stats["{#NAME}"]'
              tags:
                - tag: component
                  value: memory
                - tag: container
                  value: "{#NAME}"
            - uuid: 4ab3f13ab7714367b971eada3f01c613
              name: "Container {#NAME}: Network RX"
              type: DEPENDENT
              key: 'docker.container_stats.net.rx["{#NAME}"]'
              delay: "0"
              value_type: FLOAT
              units: bps
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - "$.networks[*].rx_bytes.sum()"
                  error_handler: CUSTOM_VALUE
                  error_handler_params: "0"
                - type: CHANGE_PER_SECOND
                - type: MULTIPLIER
                  parameters:
                    - "8"
              master_item:
                key: 'docker.container_stats["{#NAME}"]'
              tags:
                - tag: component
                  value: network
                - tag: container
                  value: "{#NAME}"
            - uuid: da4bf99b26e540fdafc0ee99d50e1c6e
              name: "Container {#NAME}: Network TX"
              type: DEPENDENT
              key: 'docker.container_stats.net.tx["{#NAME}"]'
              delay: "0"
              value_type: FLOAT
              units: bps
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - "$.networks[*].tx_bytes.sum()"
                  error_handler: CUSTOM_VALUE
                  error_handler_params: "0"
                - type: CHANGE_PER_SECOND
                - type: MULTIPLIER
                  parameters:
                    - "8"
              master_item:
                key: 'docker.container_stats["{#NAME}"]'
              tags:
                - tag: component
                  value: network
                - tag: container
                  value: "{#NAME}"
          trigger_prototypes:
            - uuid: db675ff608a14b12bcc02e6b500c5580
              expression: 'last(/Docker by Active Agent/docker.container_info.state.running["{#NAME}"])=0'
              name: "Docker: Container {#NAME} is not running"
              priority: WARNING
              manual_close: "YES"
              tags:
                - tag: scope
                  value: availability
          graph_prototypes:
            - uuid: 8a1c2bde3f7a4a5ca2f3d1c0b9e8f7a1
              name: "Container {#NAME}: CPU % and Memory"
              graph_items:
                - color: 1A7C11
                  item:
                    host: "Docker by Active Agent"
                    key: 'docker.container_stats.cpu_usage["{#NAME}"]'
                - color: F63100
                  item:
                    host: "Docker by Active Agent"
                    key: 'docker.container_stats.memory.usage["{#NAME}"]'
            - uuid: 1f2e3d4c5b6a49879a0b1c2d3e4f5a6b
              name: "Container {#NAME}: Network RX/TX"
              graph_items:
                - color: 2774A4
                  item:
                    host: "Docker by Active Agent"
                    key: 'docker.container_stats.net.rx["{#NAME}"]'
                - color: A54F00
                  item:
                    host: "Docker by Active Agent"
                    key: 'docker.container_stats.net.tx["{#NAME}"]'
      tags:
        - tag: class
          value: software
        - tag: target
          value: docker
        - tag: monitoring
          value: active-agent
      macros:
        - macro: "{$DOCKER.LLD.FILTER.CONTAINER.MATCHES}"
          value: ".*"
          description: "Container name filter (regex)"
        - macro: "{$DOCKER.LLD.FILTER.CONTAINER.NOT_MATCHES}"
          value: "CHANGE_IF_NEEDED"
          description: "Exclude containers (regex)"
        - macro: "{$DOCKER.CONTAINERS.STOPPED.MAX.WARN}"
          value: "1"
          description: "Maximum number of stopped containers before warning"
        - macro: "{$DOCKER.CONTAINERS.STOPPED.MAX.CRIT}"
          value: "20"
          description: "Critical threshold for stopped containers"

      valuemaps:
        - uuid: c289195aa4dc47ab883fa95c9cb6fd09
          name: "Docker flag"
          mappings:
            - value: "0"
              newvalue: "False"
            - value: "1"
              newvalue: "True"
        - uuid: 8effc3f81db14540996e2373dde6eca1
          name: "Service state"
          mappings:
            - value: "0"
              newvalue: Down
            - value: "1"
              newvalue: Up

  graphs:
    - uuid: d8fba9b1f1f04628a0a460bf3f2a12c3
      name: "Docker: Containers"
      graph_items:
        - drawtype: GRADIENT_LINE
          color: 199C0D
          item:
            host: "Docker by Active Agent"
            key: docker.containers.running
        - sortorder: "1"
          drawtype: BOLD_LINE
          color: F63100
          item:
            host: "Docker by Active Agent"
            key: docker.containers.paused
        - sortorder: "2"
          drawtype: BOLD_LINE
          color: 00611C
          item:
            host: "Docker by Active Agent"
            key: docker.containers.stopped
        - sortorder: "3"
          drawtype: BOLD_LINE
          color: F7941D
          item:
            host: "Docker by Active Agent"
            key: docker.containers.total
