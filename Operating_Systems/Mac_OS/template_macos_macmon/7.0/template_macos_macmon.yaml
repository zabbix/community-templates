zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 0b95c0e1f0684b21a1004e0ed82acd19
      name: Templates
  templates:
    - uuid: 577c9530d7064f2c90e3724cda1b5a21
      template: 'Template macOS macmon'
      name: 'Template macOS macmon'
      description: |
        Monitor power consumption, temperatures, and load using macmon utility
        
        Install and configure  
        
        1. On monitored host add macmon
        HOMEBREW_NO_AUTO_UPDATE=1 brew install macmon
        
        2. Add configuration for agent 
        cd /usr/local/etc/zabbix/zabbix_agentd
        cat > macmon.conf
        UserParameter=macmon.json,/opt/homebrew/bin/macmon pipe -s1 -i 500 | head -n1
        
        3. Restart Zabbix Agent 
        launchctl stop com.zabbix.zabbix_agentd && sleep 2 && launchctl start com.zabbix.zabbix_agentd
        
        4. Add template to host in Zabbix Server settings
      groups:
        - name: Templates
      items:
        - uuid: 0a264453de474cf5aed4acaabb77fad0
          name: 'Power: Total (all_power)'
          type: DEPENDENT
          key: macmon.all_power
          delay: '0'
          value_type: FLOAT
          units: W
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.all_power
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
          triggers:
            - uuid: 972b680efd0b4c2cbf7a459457918477
              expression: 'avg(/Template macOS macmon/macmon.all_power,5)>={$MAX_POWER}'
              name: 'Power Usage over {$MAX_POWER} W'
              priority: WARNING
              description: 'Average power usage over {$MAX_POWER} W in 5 min'
              manual_close: 'YES'
              tags:
                - tag: Template
                  value: macmon
        - uuid: fed1c6dba70545108bdb317bc994e41a
          name: 'Power: ANE'
          type: DEPENDENT
          key: macmon.ane_power
          delay: '0'
          value_type: FLOAT
          units: W
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.ane_power
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: 7fc3570598ad45cca658e6b9c6d6d21f
          name: 'Power: CPU'
          type: DEPENDENT
          key: macmon.cpu_power
          delay: '0'
          value_type: FLOAT
          units: W
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.cpu_power
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: 9529a5e266db4984b6eca08ca4f22c36
          name: 'Temperature: CPU average'
          type: DEPENDENT
          key: macmon.cpu_temp_avg
          delay: '0'
          value_type: FLOAT
          units: °C
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.temp.cpu_temp_avg
            - type: IN_RANGE
              parameters:
                - '0'
                - '200'
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
          triggers:
            - uuid: be00c3b52d1948dfb3578875cf6dcb75
              expression: 'min(/Template macOS macmon/macmon.cpu_temp_avg,5)>={$MAX_CPU_TEMP}'
              name: 'Temperature CPU over {$MAX_CPU_TEMP} °C'
              priority: AVERAGE
              description: 'CPU Temperature is over {$MAX_GPU_TEMP} °C'
              tags:
                - tag: Template
                  value: macmon
        - uuid: a0a9798ec9d94e06b42b87173dd4aba6
          name: 'Frequency: E-cores Hz'
          type: DEPENDENT
          key: macmon.ecpu_frequency_hz
          delay: '0'
          value_type: FLOAT
          units: Hz
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.ecpu_usage[0]'
            - type: MULTIPLIER
              parameters:
                - '1000000'
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: e2ad66dd38344aa28530943bdd0f0b92
          name: 'Usage: E-cores %'
          type: DEPENDENT
          key: macmon.ecpu_usage_pct
          delay: '0'
          value_type: FLOAT
          units: '%'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.ecpu_usage[1]'
            - type: MULTIPLIER
              parameters:
                - '100'
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: f44422387f564cdb87140a9b43e264d3
          name: 'Frequency: GPU Hz'
          type: DEPENDENT
          key: macmon.gpu_frequency_hz
          delay: '0'
          value_type: FLOAT
          units: Hz
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.gpu_usage[0]'
            - type: MULTIPLIER
              parameters:
                - '1000000'
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: edce0fb2b4464646aa9ac78788e0c407
          name: 'Power: GPU'
          type: DEPENDENT
          key: macmon.gpu_power
          delay: '0'
          value_type: FLOAT
          units: W
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.gpu_power
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: a8bff17b6fab49a79ed6ae02b5f02d7e
          name: 'Power: GPU RAM'
          type: DEPENDENT
          key: macmon.gpu_ram_power
          delay: '0'
          value_type: FLOAT
          units: W
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.gpu_ram_power
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: cb2722ddb4fb457b9123ec99107eff9a
          name: 'Temperature: GPU average'
          type: DEPENDENT
          key: macmon.gpu_temp_avg
          delay: '0'
          value_type: FLOAT
          units: °C
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.temp.gpu_temp_avg
            - type: IN_RANGE
              parameters:
                - '0'
                - '200'
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
          triggers:
            - uuid: a60d7c5bd1054a319b88c9d8026a5e12
              expression: 'min(/Template macOS macmon/macmon.gpu_temp_avg,5)>={$MAX_GPU_TEMP}'
              name: 'Temperature  GPU over {$MAX_GPU_TEMP} °C'
              priority: WARNING
              description: 'GPU Temperature is over {$MAX_GPU_TEMP} °C'
              tags:
                - tag: Template
                  value: macmon
        - uuid: 8761ef77a681497a9d8f159ef231be3e
          name: 'Usage: GPU %'
          type: DEPENDENT
          key: macmon.gpu_usage_pct
          delay: '0'
          value_type: FLOAT
          units: '%'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.gpu_usage[1]'
            - type: MULTIPLIER
              parameters:
                - '100'
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: 0a264453de474cf5aed4acaabb77fad9
          name: 'macmon: raw JSON output'
          type: ZABBIX_ACTIVE
          key: macmon.json
          history: 1d
          value_type: TEXT
          trends: '0'
          tags:
            - tag: macmon
        - uuid: 7bba5450874946aeb17e55a84a016d2b
          name: 'Frequency: P-cores Hz'
          type: DEPENDENT
          key: macmon.pcpu_frequency_hz
          delay: '0'
          value_type: FLOAT
          units: Hz
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.pcpu_usage[0]'
            - type: MULTIPLIER
              parameters:
                - '1000000'
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: a1161e5aaa1640f3b389f2be7a216293
          name: 'Usage: P-cores %'
          type: DEPENDENT
          key: macmon.pcpu_usage_pct
          delay: '0'
          value_type: FLOAT
          units: '%'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.pcpu_usage[1]'
            - type: MULTIPLIER
              parameters:
                - '100'
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: fbb4163511e34ab3a5f2e872727c1357
          name: 'Memory: Usage %'
          type: CALCULATED
          key: macmon.ram_pct
          delay: 60s
          value_type: FLOAT
          units: '%'
          params: '(last(//macmon.ram_used) / last(//macmon.ram_total) * 100)'
          tags:
            - tag: macmon
          triggers:
            - uuid: 70c6caedfdad4b43a5202038aafb2580
              expression: 'min(/Template macOS macmon/macmon.ram_pct,5m) >= {$MEMORY_USE_PERCENT}'
              name: 'Memory Usage over {$MEMORY_USE_PERCENT}%'
              priority: WARNING
              description: 'Usage memory is over {$MEMORY_USE_PERCENT}%'
              tags:
                - tag: Template
                  value: macmon
        - uuid: 8b7805dc7ead44879cc15e6cfaa83c47
          name: 'Memory: Total (bytes)'
          type: DEPENDENT
          key: macmon.ram_total
          delay: '0'
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.memory.ram_total
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: e9ee0e0b405c42358ffe4e1fc5cf1912
          name: 'Memory: Used (bytes)'
          type: DEPENDENT
          key: macmon.ram_used
          delay: '0'
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.memory.ram_usage
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: ed5c9c261946434c9bf84b27578e4296
          name: 'Memory: Swap Total (bytes)'
          type: DEPENDENT
          key: macmon.swap_total
          delay: '0'
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.memory.swap_total
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
        - uuid: 9728a89df9ac472c8c0670cecf4754b7
          name: 'Memory: Swap Usage (bytes)'
          type: DEPENDENT
          key: macmon.swap_usage
          delay: '0'
          units: B
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.memory.swap_usage
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
          triggers:
            - uuid: c4d4f85b4c22490aaba5810277eec0b8
              expression: 'min(/Template macOS macmon/macmon.swap_usage,5m)/1073741824 >= {$SWAP_ALERT_SIZE}'
              name: 'SWAP Usage over {$SWAP_ALERT_SIZE} GB'
              priority: WARNING
              description: 'Usage swap is over {$SWAP_ALERT_SIZE} GB'
              tags:
                - tag: Template
                  value: macmon
        - uuid: 86847a4683a146e4ac639c51325bb8cc
          name: 'Power: System total'
          type: DEPENDENT
          key: macmon.sys_power
          delay: '0'
          value_type: FLOAT
          units: W
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.sys_power
          master_item:
            key: macmon.json
          tags:
            - tag: macmon
      macros:
        - macro: '{$MAX_CPU_TEMP}'
          value: '95'
          description: 'Max CPU TEMP'
        - macro: '{$MAX_GPU_TEMP}'
          value: '95'
          description: 'Max GPU TEMP'
        - macro: '{$MAX_POWER}'
          value: '25'
          description: 'Max Power Usage'
        - macro: '{$MEMORY_USE_PERCENT}'
          value: '95'
          description: 'Max Memory Usage %'
        - macro: '{$SWAP_ALERT_SIZE}'
          value: '4'
          description: 'Swap Alert size in GB'
      dashboards:
        - uuid: 48c1383e311e4931bef2f78d816ae0e3
          name: MacMon
          pages:
            - widgets:
                - type: graph
                  width: '24'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid.0
                      value:
                        host: 'Template macOS macmon'
                        name: Usage
                    - type: STRING
                      name: reference
                      value: EZRMB
                - type: graph
                  'y': '5'
                  width: '24'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid.0
                      value:
                        host: 'Template macOS macmon'
                        name: Swap
                    - type: STRING
                      name: reference
                      value: BNGIH
                - type: graph
                  x: '24'
                  width: '24'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid.0
                      value:
                        host: 'Template macOS macmon'
                        name: Frequency
                    - type: STRING
                      name: reference
                      value: SHBAA
                - type: graph
                  x: '24'
                  'y': '5'
                  width: '24'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid.0
                      value:
                        host: 'Template macOS macmon'
                        name: Power
                    - type: STRING
                      name: reference
                      value: HQNAU
                - type: graph
                  x: '48'
                  width: '24'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid.0
                      value:
                        host: 'Template macOS macmon'
                        name: Temperature
                    - type: STRING
                      name: reference
                      value: SVPKK
                - type: graph
                  x: '48'
                  'y': '5'
                  width: '24'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid.0
                      value:
                        host: 'Template macOS macmon'
                        name: Memory
                    - type: STRING
                      name: reference
                      value: UTRZB
  graphs:
    - uuid: 95acef9ad5694430a2534bfa101f5b73
      name: Frequency
      ymin_type_1: FIXED
      graph_items:
        - color: F63100
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.pcpu_frequency_hz
        - sortorder: '1'
          color: 1A7C11
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.ecpu_frequency_hz
        - sortorder: '2'
          color: '274482'
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.gpu_frequency_hz
    - uuid: b8558eceecfe463290100f1fec3a46c0
      name: Memory
      ymin_type_1: FIXED
      ymax_type_1: ITEM
      ymax_item_1:
        host: 'Template macOS macmon'
        key: macmon.ram_total
      graph_items:
        - color: F63100
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.ram_total
        - sortorder: '1'
          drawtype: GRADIENT_LINE
          color: 1E88E5
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.ram_used
    - uuid: 93e3e6b917e84317a4cb6d465bfa0493
      name: Power
      graph_items:
        - color: A54F10
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.sys_power
        - sortorder: '1'
          color: FC6EA3
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.all_power
        - sortorder: '2'
          color: F63100
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.cpu_power
        - sortorder: '3'
          color: '274482'
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.gpu_power
        - sortorder: '4'
          color: 1A7C11
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.ane_power
        - sortorder: '5'
          color: 1E88E5
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.gpu_ram_power
    - uuid: 341d257c278b4a6798d1875626d0e68c
      name: Swap
      ymin_type_1: FIXED
      graph_items:
        - color: FF4000
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.swap_total
        - sortorder: '1'
          drawtype: GRADIENT_LINE
          color: '009688'
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.swap_usage
    - uuid: 3f2519f1e4354289bba8a7265fc92cda
      name: Temperature
      ymin_type_1: FIXED
      graph_items:
        - color: 1A7C11
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.cpu_temp_avg
        - sortorder: '1'
          color: '274482'
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.gpu_temp_avg
    - uuid: 2f2ad264216f4a5aa13c371750363475
      name: Usage
      ymin_type_1: FIXED
      ymax_type_1: FIXED
      graph_items:
        - color: F63100
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.pcpu_usage_pct
        - sortorder: '1'
          color: 1A7C11
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.ecpu_usage_pct
        - sortorder: '2'
          color: '274482'
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.gpu_usage_pct
        - sortorder: '3'
          color: 1E88E5
          calc_fnc: ALL
          item:
            host: 'Template macOS macmon'
            key: macmon.ram_pct
