<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export><version>5.0</version><date>2021-11-25T12:36:39Z</date><groups><group><name>Templates</name></group></groups><templates><template><template>ESXi HP Smart Array</template><name>ESXi HP Smart Array</name><groups><group><name>Templates</name></group></groups><applications><application><name>HP Smart Array</name></application></applications><items><item><name>Smart Array: Data Retrieval</name><type>SSH</type><key>ssh.run[hpraid.data.retrieval]</key><delay>600</delay><trends>0</trends><value_type>TEXT</value_type><params>data_tmp=&quot;/tmp/hp-raid-data-harvester.tmp&quot;&#13;
data_out=&quot;/tmp/hp-raid-data-harvester.out&quot;&#13;
hpacucli=&quot;/opt/hp/hpssacli/bin/hpssacli&quot;&#13;
ctrl_list=$(${hpacucli} ctrl all show |grep -oE 'Slot [0-9]+.*?' |awk '{print $2}' |xargs echo)&#13;
&#13;
echo -n &gt; $data_tmp&#13;
&#13;
# Get adapters list and get info about each.&#13;
echo &quot;### ctrl section begin ###&quot; &gt;&gt; $data_tmp&#13;
for slot in $ctrl_list;&#13;
  do&#13;
    echo &quot;### ctrl begin $slot ###&quot; &gt;&gt; $data_tmp&#13;
    $hpacucli ctrl slot=$slot show &gt;&gt; $data_tmp&#13;
    echo &quot;### ctrl end $slot ###&quot; &gt;&gt; $data_tmp&#13;
  done&#13;
echo &quot;### ctrl section end ###&quot; &gt;&gt; $data_tmp&#13;
&#13;
# enumerate all adapters and all logical drives on each adapter.&#13;
echo &quot;### ld section begin ###&quot; &gt;&gt; $data_tmp&#13;
for slot in $ctrl_list;&#13;
  do&#13;
    ld_list=$($hpacucli ctrl slot=$slot ld all show |grep -w logicaldrive |awk '{print $2}' |xargs echo)&#13;
  for ld in $ld_list;&#13;
    do&#13;
      echo &quot;### ld begin $slot $ld  ###&quot; &gt;&gt; $data_tmp&#13;
      $hpacucli ctrl slot=$slot ld $ld show &gt;&gt; $data_tmp&#13;
      echo &quot;### ld end $slot $ld ###&quot; &gt;&gt; $data_tmp&#13;
    done&#13;
  done&#13;
echo &quot;### ld section end ###&quot; &gt;&gt; $data_tmp&#13;
&#13;
# enumerate all adapters and all physical drives on each adapter.&#13;
echo &quot;### pd section begin ###&quot; &gt;&gt; $data_tmp&#13;
for slot in $ctrl_list;&#13;
  do&#13;
    pd_list=$($hpacucli ctrl slot=$slot pd all show |grep -w physicaldrive |awk '{print $2}' |xargs echo)&#13;
  for pd in $pd_list;&#13;
    do&#13;
      echo &quot;### pd begin $slot $pd ###&quot; &gt;&gt; $data_tmp&#13;
      $hpacucli ctrl slot=$slot pd $pd show &gt;&gt; $data_tmp&#13;
      echo &quot;### pd end $slot $pd ###&quot; &gt;&gt; $data_tmp&#13;
    done&#13;
  done&#13;
echo &quot;### pd section end ###&quot; &gt;&gt; $data_tmp&#13;
&#13;
mv $data_tmp $data_out&#13;
&#13;
echo &quot;OK&quot;</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><applications><application><name>HP Smart Array</name></application></applications></item></items><discovery_rules><discovery_rule><name>Controllers Discovery</name><type>SSH</type><key>ssh.run[hpraid.ctrl.discovery]</key><delay>86400</delay><params>data=&quot;/tmp/hp-raid-data-harvester.out&quot;&#13;
&#13;
if [ -f &quot;$data&quot; ]; then&#13;
  ctrl_list=$(sed -n -e '/ctrl section begin/,/ctrl section end/p' $data |grep -oE 'Slot [0-9]+.*?' |awk '{print $2}')&#13;
  else echo &quot;$data not found.&quot;; exit 1&#13;
fi&#13;
&#13;
echo -n '{&quot;data&quot;:['&#13;
for ctrl in $ctrl_list; do echo -n &quot;{\&quot;{#CTRL_SLOT}\&quot;: \&quot;$ctrl\&quot;},&quot;; done |sed -e 's:\},$:\}:'&#13;
echo -n ']}'</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><filter><conditions><condition><macro>{#CTRL_SLOT}</macro><formulaid>A</formulaid></condition></conditions></filter><lifetime>0</lifetime><item_prototypes><item_prototype><name>Smart Array: Battery status on slot {#CTRL_SLOT}</name><type>SSH</type><key>ssh.run[hpraid.bbu.status.{#CTRL_SLOT}]</key><delay>21600</delay><history>7d</history><trends>0</trends><value_type>TEXT</value_type><params>output=$(sed -n -e &quot;/ctrl begin {#CTRL_SLOT}/,/ctrl end {#CTRL_SLOT}/p&quot; /tmp/hp-raid-data-harvester.out |grep -wE &quot;[ ]+Battery/Capacitor Status:&quot; |awk '{print $3}')&#13;
if [ -z $output ]; then&#13;
  echo &quot;Not available&quot;&#13;
else&#13;
  echo &quot;$output&quot;&#13;
fi</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><applications><application><name>HP Smart Array</name></application></applications><trigger_prototypes><trigger_prototype><expression>{regexp(OK|Not available)}=0</expression><name>Smart Array: Controller Battery in slot {#CTRL_SLOT} state is {ITEM.LASTVALUE}</name><priority>HIGH</priority></trigger_prototype></trigger_prototypes></item_prototype><item_prototype><name>Smart Array: Cache $2 status on slot {#CTRL_SLOT}</name><type>SSH</type><key>ssh.run[hpraid.cache.status.{#CTRL_SLOT}]</key><delay>21600</delay><history>7d</history><trends>0</trends><value_type>TEXT</value_type><params>output=$(sed -n -e &quot;/ctrl begin {#CTRL_SLOT}/,/ctrl end {#CTRL_SLOT}/p&quot; /tmp/hp-raid-data-harvester.out |grep -wE &quot;[ ]+Cache Status:&quot; |awk '{print $3}')&#13;
if [ -z $output ]; then&#13;
  echo &quot;Not available&quot;&#13;
else&#13;
  echo &quot;$output&quot;&#13;
fi</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><applications><application><name>HP Smart Array</name></application></applications><trigger_prototypes><trigger_prototype><expression>{regexp(OK|Not available)}=0</expression><name>Smart Array: Controller Cache in slot {#CTRL_SLOT} state is {ITEM.LASTVALUE}</name><priority>HIGH</priority></trigger_prototype></trigger_prototypes></item_prototype><item_prototype><name>Smart Array: Controller status on slot {#CTRL_SLOT}</name><type>SSH</type><key>ssh.run[hpraid.ctrl.status.{#CTRL_SLOT}]</key><delay>21600</delay><history>7d</history><trends>0</trends><value_type>TEXT</value_type><params>sed -n -e &quot;/ctrl begin {#CTRL_SLOT}/,/ctrl end {#CTRL_SLOT}/p&quot; /tmp/hp-raid-data-harvester.out |grep -wE &quot;[ ]+Controller Status:&quot; |awk '{print $3}'</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><applications><application><name>HP Smart Array</name></application></applications><trigger_prototypes><trigger_prototype><expression>{regexp(OK)}=0</expression><name>Smart Array: Controller in slot {#CTRL_SLOT} state is {ITEM.LASTVALUE}</name><priority>HIGH</priority></trigger_prototype><trigger_prototype><expression>{nodata(24h)}=1</expression><name>Smart Array: No controller data received for &gt;24h</name><priority>HIGH</priority></trigger_prototype></trigger_prototypes></item_prototype></item_prototypes></discovery_rule><discovery_rule><name>Logical Volumes Discovery</name><type>SSH</type><key>ssh.run[hpraid.ld.discovery]</key><delay>21600</delay><params>data=&quot;/tmp/hp-raid-data-harvester.out&quot;&#13;
&#13;
if [ -f $data ]; then&#13;
  ld_list=$(sed -n -e '/ld section begin/,/ld section end/p' $data |grep -w 'ld begin' |awk '{OFS=&quot;:&quot;} {print $4,$5}')&#13;
  else echo &quot;$data not found.&quot;; exit 1&#13;
fi&#13;
&#13;
echo -n '{&quot;data&quot;:['&#13;
  for ld in $ld_list; do echo -n &quot;{\&quot;{#LD}\&quot;:\&quot;$ld\&quot;},&quot;; done |sed -e 's:\},$:\}:'&#13;
echo -n ']}'</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><filter><conditions><condition><macro>{#LD}</macro><formulaid>A</formulaid></condition></conditions></filter><lifetime>0</lifetime><item_prototypes><item_prototype><name>Logical volume $1 status</name><type>SSH</type><key>ssh.run[hpraid.ld.status.{#LD}]</key><delay>600</delay><history>7d</history><trends>0</trends><value_type>TEXT</value_type><params>slot=$(echo &quot;{#LD}&quot; | cut -d &quot;:&quot; -f 1)&#13;
ld=$(echo &quot;{#LD}&quot; | cut -d &quot;:&quot; -f 2)&#13;
sed -n -e &quot;/ld begin $slot $ld/,/ld end $slot $ld/p&quot; /tmp/hp-raid-data-harvester.out |grep -wE &quot;[ ]+Status:&quot; |awk '{print $2}'</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><applications><application><name>HP Smart Array</name></application></applications><trigger_prototypes><trigger_prototype><expression>{str(OK)}=0</expression><name>Smart Array: Logical Volume state is {ITEM.LASTVALUE} on {HOSTNAME}</name><priority>HIGH</priority></trigger_prototype></trigger_prototypes></item_prototype></item_prototypes></discovery_rule><discovery_rule><name>Physical Drives Discovery</name><type>SSH</type><key>ssh.run[hpraid.pd.discovery]</key><delay>86400</delay><params>data=&quot;/tmp/hp-raid-data-harvester.out&quot;&#13;
&#13;
if [ -f $data ]; then&#13;
  pd_list=$(sed -n -e '/pd section begin/,/pd section end/p' $data |grep -w 'pd begin' |awk '{OFS=&quot;:&quot;} {print $4,$5}')&#13;
  else echo &quot;$data not found.&quot;; exit 1&#13;
fi&#13;
&#13;
echo -n '{&quot;data&quot;:['&#13;
  for pd in $pd_list; do echo -n &quot;{\&quot;{#PD}\&quot;:\&quot;$pd\&quot;},&quot;; done |sed -e 's:\},$:\}:'&#13;
echo -n ']}'</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><filter><conditions><condition><macro>{#PD}</macro><formulaid>A</formulaid></condition></conditions></filter><lifetime>0</lifetime><item_prototypes><item_prototype><name>Physical drive {#PD} status</name><type>SSH</type><key>ssh.run[hpraid.pd.status.{#PD}]</key><delay>600</delay><history>7d</history><trends>0</trends><value_type>TEXT</value_type><params>slot=$(echo &quot;{#PD}&quot; | cut -d &quot;:&quot; -f 1)&#13;
pd=$(echo &quot;{#PD}&quot; | cut -d &quot;:&quot; -f 2-)&#13;
sed -n -e &quot;/pd begin $slot $pd/,/pd end $slot $pd/p&quot; /tmp/hp-raid-data-harvester.out |grep -wE '[ ]+Status:' |awk '{print $2}'</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><applications><application><name>HP Smart Array</name></application></applications><trigger_prototypes><trigger_prototype><expression>{str(OK)}=0</expression><name>Smart Array: Disk state is {ITEM.LASTVALUE} on {HOSTNAME}</name><priority>HIGH</priority></trigger_prototype></trigger_prototypes></item_prototype><item_prototype><name>Physical drive {#PD} temperature</name><type>SSH</type><key>ssh.run[hpraid.pd.temperature.{#PD}]</key><delay>600</delay><history>7d</history><params>slot=$(echo &quot;{#PD}&quot; | cut -d &quot;:&quot; -f 1)&#13;
pd=$(echo &quot;{#PD}&quot; | cut -d &quot;:&quot; -f 2-)&#13;
sed -n -e &quot;/pd begin $slot $pd/,/pd end $slot $pd/p&quot; /tmp/hp-raid-data-harvester.out |grep -wE '[ ]+Current Temperature \(C\):' |awk '{print $4}'</params><username>{$ZABBIX_SSH_USER}</username><password>{$ZABBIX_SSH_PASS}</password><applications><application><name>HP Smart Array</name></application></applications></item_prototype></item_prototypes></discovery_rule></discovery_rules><macros><macro><macro>{$ZABBIX_SSH_PASS}</macro><value>zabbixPassword</value></macro><macro><macro>{$ZABBIX_SSH_USER}</macro><value>zabbixUsername</value></macro></macros></template></templates></zabbix_export>
