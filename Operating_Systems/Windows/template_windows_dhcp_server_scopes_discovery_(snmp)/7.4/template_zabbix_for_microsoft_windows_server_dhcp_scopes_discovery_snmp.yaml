zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: 7df96b18c230490a9a0a9e2307226338
      name: Templates
    - uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    - uuid: a9d78294f540492e9690412347162a5f
      template: 'Windows Server DHCP Scopes by SNMP'
      name: 'Windows Server DHCP Scopes by SNMP'
      description: 'SNMP DHCP scope discovery for Windows Server.'
      groups:
        - name: Templates
        - name: Templates/Applications
      items:
        - uuid: 4f8e5ebd6ff6426daa8724933f21cc37
          name: 'DHCP: ACKs, total'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.311.1.3.1.6.0
          key: dhcp.acks
          history: 7d
          description: 'Total number of DHCP ACK messages sent by the server. MIB object: DHCP-MIB::dhcpAcks'
          tags:
            - tag: component
              value: dhcp
        - uuid: ac6e4f9985544edd83f7e4f959b62697
          name: 'DHCP: Declines, total'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.311.1.3.1.8.0
          key: dhcp.declines
          history: 7d
          description: 'Total number of DHCP DECLINE messages received by the server. MIB object: DHCP-MIB::dhcpDeclines'
          tags:
            - tag: component
              value: dhcp
        - uuid: 7a6f75afbea044feab8ff6c1a60f5823
          name: 'DHCP: Discovers, total'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.311.1.3.1.2.0
          key: dhcp.discovers
          history: 7d
          description: 'Total number of DHCP DISCOVER messages received by the server. MIB object: DHCP-MIB::dhcpDiscovers'
          tags:
            - tag: component
              value: dhcp
        - uuid: 6b5bd5345257451a8c33342d01a433c2
          name: 'DHCP: NACKs, total'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.311.1.3.1.7.0
          key: dhcp.nacks
          history: 7d
          description: 'Total number of DHCP NACK messages sent by the server. MIB object: DHCP-MIB::dhcpNacks'
          tags:
            - tag: component
              value: dhcp
        - uuid: 68b8cdef42d44c4b8f2dae645831358d
          name: 'DHCP: Offers, total'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.311.1.3.1.5.0
          key: dhcp.offers
          history: 7d
          description: 'Total number of DHCP OFFER messages sent by the server. MIB object: DHCP-MIB::dhcpOffers'
          tags:
            - tag: component
              value: dhcp
        - uuid: 9508317e9beb484b97819f2c0367ac90
          name: 'DHCP: Releases, total'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.311.1.3.1.4.0
          key: dhcp.releases
          history: 7d
          description: 'Total number of DHCP RELEASE messages received by the server. MIB object: DHCP-MIB::dhcpReleases'
          tags:
            - tag: component
              value: dhcp
        - uuid: ddbc0533d6b6455190f0a6105f5472f9
          name: 'DHCP: Requests, total'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.311.1.3.1.3.0
          key: dhcp.requests
          history: 7d
          description: 'Total number of DHCP REQUEST messages received by the server. MIB object: DHCP-MIB::dhcpRequests'
          tags:
            - tag: component
              value: dhcp
        - uuid: 695e5a38ca674c5baffa1de2db814ab1
          name: 'DHCP: Get scope data'
          type: SNMP_AGENT
          snmp_oid: 'walk[1.3.6.1.4.1.311.1.3.2.1.1]'
          key: dhcp.walk
          history: '0'
          value_type: TEXT
          description: 'Master item that performs SNMP walk to collect all DHCP scope data. The raw data is converted to JSON format for use by dependent items. This item stores no history as it contains unprocessed values.'
          preprocessing:
            - type: SNMP_WALK_TO_JSON
              parameters:
                - ipscope
                - .1.3.6.1.4.1.311.1.3.2.1.1.1
                - '0'
                - ipused
                - .1.3.6.1.4.1.311.1.3.2.1.1.2
                - '0'
                - ipfree
                - .1.3.6.1.4.1.311.1.3.2.1.1.3
                - '0'
                - ipoffers
                - .1.3.6.1.4.1.311.1.3.2.1.1.4
                - '0'
          tags:
            - tag: component
              value: raw
      discovery_rules:
        - uuid: 9bd7f05a53154e129837f8e8d646e1da
          name: 'DHCP: Scopes discovery'
          type: DEPENDENT
          key: dhcp.scope.discovery
          lifetime: 30d
          enabled_lifetime_type: DISABLE_NEVER
          description: 'Discovers all DHCP scopes configured on the Windows Server. The discovery uses data from the master SNMP walk item and automatically creates monitoring items for each discovered scope.'
          item_prototypes:
            - uuid: bf644cfab3d94538a2a594615bf9bff1
              name: 'DHCP: Scope [{#IPSCOPE}]: IPs used'
              type: DEPENDENT
              key: 'dhcp.allocated[{#IPSCOPE}]'
              description: 'Number of IP addresses currently allocated (leased) in the DHCP scope {#IPSCOPE}.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$[?(@.ipscope==''{#IPSCOPE}'')].ipused'
                - type: REGEX
                  parameters:
                    - '.*?(\d+).*?'
                    - \1
              master_item:
                key: dhcp.walk
              tags:
                - tag: component
                  value: scope
                - tag: scope
                  value: '{#IPSCOPE}'
            - uuid: 31cc57caf2234a84b907a0bc5d53f7cb
              name: 'DHCP: Scope [{#IPSCOPE}]: IPs free'
              type: DEPENDENT
              key: 'dhcp.free[{#IPSCOPE}]'
              description: 'Number of free (available) IP addresses in the DHCP scope {#IPSCOPE}.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$[?(@.ipscope=="{#IPSCOPE}")].ipfree'
                - type: REGEX
                  parameters:
                    - '.*?(\d+).*?'
                    - \1
              master_item:
                key: dhcp.walk
              tags:
                - tag: component
                  value: scope
                - tag: scope
                  value: '{#IPSCOPE}'
            - uuid: 68e81fad7ce94044b46ac51c19be653d
              name: 'DHCP: Scope [{#IPSCOPE}]: IPs offered'
              type: DEPENDENT
              key: 'dhcp.offers[{#IPSCOPE}]'
              description: 'Number of IP addresses currently offered but not yet acknowledged in the DHCP scope {#IPSCOPE}.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$[?(@.ipscope=="{#IPSCOPE}")].ipoffers'
                - type: REGEX
                  parameters:
                    - '.*?(\d+).*?'
                    - ' \1'
              master_item:
                key: dhcp.walk
              tags:
                - tag: component
                  value: scope
                - tag: scope
                  value: '{#IPSCOPE}'
            - uuid: c414aeac00f44806af0f01ed5d33e2f8
              name: 'DHCP: Scope [{#IPSCOPE}]: Network'
              type: DEPENDENT
              key: 'dhcp.scope.network[{#IPSCOPE}]'
              value_type: TEXT
              description: 'The network address/subnet of the DHCP scope {#IPSCOPE}. This value rarely changes.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$[?(@.ipscope=="{#IPSCOPE}")].ipscope'
                - type: STR_REPLACE
                  parameters:
                    - '["'
                    - ''
                - type: STR_REPLACE
                  parameters:
                    - '"]'
                    - ''
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
              master_item:
                key: dhcp.walk
              tags:
                - tag: component
                  value: scope
                - tag: scope
                  value: '{#IPSCOPE}'
            - uuid: 78894d8d90af48ba840229dfcddc0d14
              name: 'DHCP: Scope [{#IPSCOPE}]: Utilization, in %'
              type: CALCULATED
              key: 'dhcp.used.percent[{#IPSCOPE}]'
              units: '%'
              params: |
                100 * last(//dhcp.allocated[{#IPSCOPE}]) /
                     ( last(//dhcp.allocated[{#IPSCOPE}]) + last(//dhcp.free[{#IPSCOPE}]) )
              description: 'Percentage of the DHCP scope {#IPSCOPE} that is currently in use. Calculated as: (Used IPs / (Used IPs + Free IPs)) * 100. This metric is used for capacity monitoring and alerting.'
              tags:
                - tag: component
                  value: scope
                - tag: scope
                  value: '{#IPSCOPE}'
              trigger_prototypes:
                - uuid: 1af43a6198eb4489a3bd5c43f96e7cd0
                  expression: 'last(/Windows Server DHCP Scopes by SNMP/dhcp.used.percent[{#IPSCOPE}],#1)>=95'
                  name: 'DHCP: Scope [{#IPSCOPE}]: Critical low free IPs (< 5%)'
                  event_name: 'DHCP: Scope [{#IPSCOPE}]: Critical low free IPs (utilization: {ITEM.LASTVALUE1})'
                  opdata: 'Utilization: {ITEM.LASTVALUE1}'
                  priority: HIGH
                  description: |
                    The DHCP scope {#IPSCOPE} has less than 5% of IP addresses available. Immediate action is required to prevent service disruption.
                    
                    Possible actions:
                    - Expand the DHCP scope range
                    - Reduce lease time to free up unused addresses faster
                    - Investigate if there are devices holding multiple leases
                    - Check for DHCP exhaustion attacks
                  dependencies:
                    - name: 'DHCP: Scope [{#IPSCOPE}]: Low free IPs (< 10%)'
                      expression: 'last(/Windows Server DHCP Scopes by SNMP/dhcp.used.percent[{#IPSCOPE}],#1)>=90'
                  tags:
                    - tag: component
                      value: scope
                    - tag: scope
                      value: capacity
                    - tag: scope
                      value: '{#IPSCOPE}'
                - uuid: dfa7cac472e7420e9d3ee937112e6e0d
                  expression: 'change(/Windows Server DHCP Scopes by SNMP/dhcp.used.percent[{#IPSCOPE}])>10'
                  recovery_mode: NONE
                  name: 'DHCP: Scope [{#IPSCOPE}]: High volume of leases'
                  event_name: 'DHCP: Scope [{#IPSCOPE}]: High volume of leases (change: {ITEM.LASTVALUE1})'
                  opdata: 'Utilization change: {ITEM.LASTVALUE1}'
                  priority: HIGH
                  description: |
                    There has been a sudden increase of more than 10% in DHCP scope utilization within the last check interval. This may indicate:
                    
                    - A DHCP exhaustion attack
                    - A network issue causing mass reconnections
                    - A large number of new devices connecting to the network
                    - A misconfigured device requesting multiple IP addresses
                    
                    Investigate the cause immediately to prevent potential service disruption.
                  manual_close: 'YES'
                  tags:
                    - tag: component
                      value: scope
                    - tag: scope
                      value: performance
                    - tag: scope
                      value: '{#IPSCOPE}'
                - uuid: e4626542d5a14af59e9e46ff63af5357
                  expression: 'last(/Windows Server DHCP Scopes by SNMP/dhcp.used.percent[{#IPSCOPE}],#1)>=90'
                  name: 'DHCP: Scope [{#IPSCOPE}]: Low free IPs (< 10%)'
                  event_name: 'DHCP: Scope [{#IPSCOPE}]: Low free IPs (utilization: {ITEM.LASTVALUE1})'
                  opdata: 'Utilization: {ITEM.LASTVALUE1}'
                  priority: AVERAGE
                  description: |
                    The DHCP scope {#IPSCOPE} has less than 10% of IP addresses available. Consider taking action to prevent running out of addresses.
                    
                    Recommended actions:
                    - Monitor the trend to see if utilization is increasing
                    - Plan to expand the DHCP scope range if needed
                    - Review lease times and adjust if appropriate
                    - Check for unused or stale leases
                  tags:
                    - tag: component
                      value: scope
                    - tag: scope
                      value: capacity
                    - tag: scope
                      value: '{#IPSCOPE}'
          graph_prototypes:
            - uuid: 43ddf2e6e9bf43ad80cbb11003ec397d
              name: 'DHCP: Scope [{#IPSCOPE}]: IPs free/used'
              ymin_type_1: FIXED
              graph_items:
                - color: 199C0D
                  calc_fnc: ALL
                  item:
                    host: 'Windows Server DHCP Scopes by SNMP'
                    key: 'dhcp.allocated[{#IPSCOPE}]'
                - sortorder: '1'
                  color: 1E88E5
                  calc_fnc: ALL
                  item:
                    host: 'Windows Server DHCP Scopes by SNMP'
                    key: 'dhcp.free[{#IPSCOPE}]'
            - uuid: 0ca8fcbd54b8434bb307dc0f53dc5ab9
              name: 'DHCP: Scope [{#IPSCOPE}]: Utilization'
              ymin_type_1: FIXED
              ymax_type_1: FIXED
              graph_items:
                - color: 199C0D
                  calc_fnc: ALL
                  item:
                    host: 'Windows Server DHCP Scopes by SNMP'
                    key: 'dhcp.used.percent[{#IPSCOPE}]'
          master_item:
            key: dhcp.walk
          lld_macro_paths:
            - lld_macro: '{#IPFREE}'
              path: $.ipfree
            - lld_macro: '{#IPOFFERS}'
              path: $.ipoffers
            - lld_macro: '{#IPSCOPE}'
              path: $.ipscope
            - lld_macro: '{#IPUSED}'
              path: $.ipused
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
      tags:
        - tag: class
          value: software
        - tag: target
          value: dhcp
        - tag: target
          value: windows-server