zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: c2c162144c2d4c5491c8801193af4945
      name: Templates/Cloud
  templates:
    - uuid: d0d801025c9042ef81c503bb55a42ccd
      template: 'Microsoft 365 Application secrets expire by HTTP'
      name: 'Microsoft 365 Application secrets expire by HTTP'
      description: |
        This template is designed to monitor Microsoft 365 Application Secrets by HTTP. It works without any external scripts and uses script items.
        The template uses endpoints in the Microsoft Graph API to gather the infromation.

        Setup:
          1. Register the app with Microsoft Entra ID.
          2. Configure Microsoft Graph application permissions on the app ID:
            `Application.Read.All` - required for app metrics
            'Directory.Read.All' - (optional, prevents 403 in big tenents)
          3. Request administrator consent.
          4. Configure the macros: `{$MS365.APP.ID}`, `{$MS365.PASSWORD}`, `{$MS365.TENANT.ID}`.

        Inspired by 'Microsoft 365 reports by HTTP'
      vendor:
        name: Community
        version: 7.0-0
      groups:
        - name: Templates/Cloud
      items:
        - uuid: c99e3f3d4f4c4beeab93e54535f383cc
          name: 'Apps Secret Expire: Get errors'
          type: DEPENDENT
          key: ms365.apps.secret.expire.errors
          delay: '0'
          history: 7d
          value_type: TEXT
          trends: '0'
          preprocessing:
            - type: CHECK_JSON_ERROR
              parameters:
                - $.error
              error_handler: DISCARD_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          master_item:
            key: ms365.apps.secret.expire.get
          tags:
            - tag: component
              value: apps
            - tag: component
              value: error
        - uuid: 21a67461e26f45e8b199903e3bc80ad7
          name: 'Apps Secret Expire: Get'
          type: SCRIPT
          key: ms365.apps.secret.expire.get
          delay: 5m
          history: 90d
          value_type: TEXT
          trends: '0'
          params: |
            const ms365 = {
                params: {},
                token: null,

                setParams: function (params) {
                    ['app_id', 'password', 'tenant_id'].forEach(function (field) {
                        if (typeof params !== 'object' || typeof params[field] === 'undefined' || params[field] === '') {
                            throw 'Required param is not set: ' + field + '.';
                        }
                    });

                    ms365.params = params;
                },

                login: function () {
                    const response = new HttpRequest(),
                        login = new HttpRequest();

                    if (typeof ms365.params.http_proxy !== 'undefined' && ms365.params.http_proxy !== '') {
                        login.setProxy(ms365.params.http_proxy);
                        Zabbix.log(4, '[ Microsoft 365 ] Using HTTP proxy: ' + ms365.params.http_proxy);
                    }

                    login.addHeader('Content-Type: application/x-www-form-urlencoded');

                    response = login.post(
                        'https://login.microsoftonline.com/' + encodeURIComponent(ms365.params.tenant_id) + '/oauth2/v2.0/token',
                        'grant_type=client_credentials&scope=https://graph.microsoft.com/.default&client_id=' + encodeURIComponent(ms365.params.app_id) + '&client_secret=' + encodeURIComponent(ms365.params.password)
                    );

                    if (login.getStatus() < 200 || login.getStatus() >= 300) {
                        throw 'Login failed with status code ' + login.getStatus() + ': ' + response;
                    }

                    try {
                        response = JSON.parse(response);
                    }
                    catch (error) {
                        throw 'Failed to parse login session response.';
                    }

                    if (!response.hasOwnProperty('access_token')) {
                        throw 'Authentication response does not contain access token.';
                    }

                    ms365.token = response['access_token'];
                },

                request: function (url) {
                    const response = new HttpRequest(),
                          request = new HttpRequest();

                    if (typeof ms365.params.http_proxy !== 'undefined' && ms365.params.http_proxy !== '') {
                        request.setProxy(ms365.params.http_proxy);
                        Zabbix.log(4, '[ Microsoft 365 ] Using HTTP proxy: ' + ms365.params.http_proxy);
                    }

                    if (!ms365.token) {
                        throw 'Request does not contain access token.';
                    }

                    request.addHeader('Content-Type: application/json');
                    request.addHeader('Authorization: Bearer ' + ms365.token);

                    Zabbix.log(4, '[ Microsoft 365 ] Request url: ' + url);

                    response = request.get(url);

                    Zabbix.log(4, '[ Microsoft 365 ] Received response with status code ' + request.getStatus() + ': ' + response);

                    if (request.getStatus() < 200 || request.getStatus() >= 300) {
                        throw 'Request failed with status code ' + request.getStatus() + ': ' + response;
                    }

                    try {
                        return JSON.parse(response);
                    } catch (error) {
                        throw 'Failed to parse response received from API.';
                    }
                },

                getAppsWithSecretConfigured: function () {
                    const url = 'https://graph.microsoft.com/v1.0/applications?$select=id,appId,displayName,passwordCredentials',
                          response = ms365.request(url),  allApplicationsValue = [];

                    const allApplications = response.value;
                    const nextLink = response['@odata.nextLink'];

                    while (nextLink) {
                        const nextResponse = ms365.request(nextLink);
                        allApplications = allApplications.concat(nextResponse.value);
                        nextLink = nextResponse['@odata.nextLink'];
                    }

                    var appsWithSecretConfigured = [];
                    for (var i = 0; i < allApplications.length; i++) {
                        if (allApplications[i].passwordCredentials && allApplications[i].passwordCredentials.length > 0) {
                            appsWithSecretConfigured.push(allApplications[i]);
                        }
                    }
                    return appsWithSecretConfigured;
                }
            };

            try {
                ms365.setParams(JSON.parse(value));
                ms365.login();
                const appsWithSecretConfigured = ms365.getAppsWithSecretConfigured();
                return JSON.stringify(appsWithSecretConfigured);
            }
            catch (error) {
                error += (String(error).endsWith('.')) ? '' : '.';
                Zabbix.log(3, '[ Microsoft 365 ] ERROR: ' + error);
                return JSON.stringify({ 'error': error });
            }
          description: 'Accumulated data from the Microsoft Graph API "applications" endpoints.'
          timeout: '{$MS365.AS.API.TIMEOUT}'
          parameters:
            - name: app_id
              value: '{$MS365.AS.APP.ID}'
            - name: password
              value: '{$MS365.AS.PASSWORD}'
            - name: proxy
              value: '{$MS365.AS.HTTP.PROXY}'
            - name: tenant_id
              value: '{$MS365.AS.TENANT.ID}'
          tags:
            - tag: component
              value: apps
            - tag: component
              value: raw
      discovery_rules:
        - uuid: ffb5dae98f78467cbdbcda93a1273620
          name: 'Apps Secret Expire: Discovery'
          type: DEPENDENT
          key: ms365.apps.secret.expire.discovery
          delay: '0'
          lifetime: 30d
          enabled_lifetime_type: DISABLE_NEVER
          item_prototypes:
            - uuid: 7e1a67cfd9ed49d6a8d77842cea017be
              name: 'M365 Application {#NAME}: Get'
              type: DEPENDENT
              key: 'ms365.apps.secret.expire.get[{#APPID}]'
              delay: '0'
              history: '0'
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.[?(@.appId== ''{#APPID}'')]'
              master_item:
                key: ms365.apps.secret.expire.errors
              tags:
                - tag: app
                  value: '{#NAME}'
                - tag: component
                  value: raw
            - uuid: d62117b2a65a44218cf403208dfe49a6
              name: 'M365 Application {#NAME}: Expiredate'
              type: DEPENDENT
              key: 'ms365.apps.secret.expire.timestemp[{#APPID}]'
              delay: '0'
              history: 90d
              units: unixtime
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$[0].passwordCredentials'
                - type: JAVASCRIPT
                  parameters:
                    - |
                      var data = JSON.parse(value);

                      // sort Arrays by startDateTime
                      data.sort(function(a, b) {
                          var dateA = new Date(a.endDateTime);
                          var dateB = new Date(b.endDateTime);
                          return dateB - dateA;
                      });

                      return JSON.stringify(data);
                - type: JSONPATH
                  parameters:
                    - '$[*].endDateTime.first()'
                - type: JAVASCRIPT
                  parameters:
                    - |
                      //covert date fomat YYYY-MM-DDTHH:MM:SS.SSSZ to unix time stamp
                      var dateStr = value;
                      var dateObj = new Date(dateStr);
                      var unixTimestamp = Math.floor(dateObj.getTime() / 1000); // covert in seconds
                      return unixTimestamp;
              master_item:
                key: 'ms365.apps.secret.expire.get[{#APPID}]'
              tags:
                - tag: app
                  value: '{#NAME}'
                - tag: component
                  value: m365
              trigger_prototypes:
                - uuid: 3f1093fec3ae4ef786305a035d1fe7a9
                  expression: '(last(/Microsoft 365 Application secrets expire by HTTP/ms365.apps.secret.expire.timestemp[{#APPID}]) - now()) / 1d < {$MS365.AS.EXPIRE.CRIT:"{#NAME}"}'
                  name: 'Secret {#NAME}: App secret expires soon (less than {$MS365.AS.EXPIRE.CRIT:"{#NAME}"} days)'
                  priority: HIGH
                  tags:
                    - tag: scope
                      value: notice
                - uuid: cb74abb6e4a74cc79e8b6c935005389f
                  expression: '(last(/Microsoft 365 Application secrets expire by HTTP/ms365.apps.secret.expire.timestemp[{#APPID}]) - now()) / 1d < {$MS365.AS.EXPIRE.WARN.LOW:"{#NAME}"}'
                  name: 'Secret {#NAME}: App secret expires soon (less than {$MS365.AS.EXPIRE.WARN.LOW:"{#NAME}"} days)'
                  priority: INFO
                  dependencies:
                    - name: 'Secret {#NAME}: App secret expires soon (less than {$MS365.AS.EXPIRE.WARN:"{#NAME}"} days)'
                      expression: '(last(/Microsoft 365 Application secrets expire by HTTP/ms365.apps.secret.expire.timestemp[{#APPID}]) - now()) / 1d < {$MS365.AS.EXPIRE.WARN:"{#NAME}"}'
                  tags:
                    - tag: scope
                      value: notice
                - uuid: 1c3794638cc04c24a52582d39cd8fb8f
                  expression: '(last(/Microsoft 365 Application secrets expire by HTTP/ms365.apps.secret.expire.timestemp[{#APPID}]) - now()) / 1d < {$MS365.AS.EXPIRE.WARN:"{#NAME}"}'
                  name: 'Secret {#NAME}: App secret expires soon (less than {$MS365.AS.EXPIRE.WARN:"{#NAME}"} days)'
                  priority: WARNING
                  dependencies:
                    - name: 'Secret {#NAME}: App secret expires soon (less than {$MS365.AS.EXPIRE.CRIT:"{#NAME}"} days)'
                      expression: '(last(/Microsoft 365 Application secrets expire by HTTP/ms365.apps.secret.expire.timestemp[{#APPID}]) - now()) / 1d < {$MS365.AS.EXPIRE.CRIT:"{#NAME}"}'
                  tags:
                    - tag: scope
                      value: notice
          master_item:
            key: ms365.apps.secret.expire.get
          lld_macro_paths:
            - lld_macro: '{#APPID}'
              path: '$[''appId'']'
            - lld_macro: '{#NAME}'
              path: '$[''displayName'']'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
      tags:
        - tag: class
          value: cloud
        - tag: target
          value: 'ms365 enterprise applications'
      macros:
        - macro: '{$MS365.AS.API.TIMEOUT}'
          value: 15s
          description: 'API response timeout.'
        - macro: '{$MS365.AS.APP.ID}'
          description: 'Microsoft application ID.'
        - macro: '{$MS365.AS.EXPIRE.CRIT}'
          value: '7'
        - macro: '{$MS365.AS.EXPIRE.WARN}'
          value: '14'
        - macro: '{$MS365.AS.EXPIRE.WARN.LOW}'
          value: '30'
        - macro: '{$MS365.AS.HTTP.PROXY}'
          description: 'Sets the HTTP proxy value. If this macro is empty, then no proxy is used.'
        - macro: '{$MS365.AS.PASSWORD}'
          description: 'The secret for the registered Microsoft application.'
        - macro: '{$MS365.AS.SERVICE.NAME.MATCHES}'
          value: '.*'
          description: 'This macro is used in the Microsoft cloud service discovery rule.'
        - macro: '{$MS365.AS.SERVICE.NAME.NOT.MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in the Microsoft cloud service discovery rule.'
        - macro: '{$MS365.AS.TENANT.ID}'
          description: 'Microsoft tenant ID.'
