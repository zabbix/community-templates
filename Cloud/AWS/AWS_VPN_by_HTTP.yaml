zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: c2c162144c2d4c5491c8801193af4945
      name: Templates/Cloud
  templates:
    - uuid: 5ce05335fd28485dade61a281794d14d
      template: 'AWS VPN by HTTP'
      name: 'AWS VPN by HTTP'
      description: |
        Get AWS VPN status.
        
        Generated by Karthick (https://github.com/karthick-dkk).
      groups:
        - name: Templates/Cloud
      items:
        - uuid: 1595f91c33844c1b878adbae0da8c1f6
          name: 'Get all VPNs raw data'
          type: SCRIPT
          key: aws.get.vpn
          delay: 3m
          value_type: TEXT
          trends: '0'
          params: |
            var AWS = {
                params: {},
                metadata: 'http://169.254.169.254/latest/',
            
                getField: function (obj, path) {
                    var parts = path.split('.');
                    for (var i = 0; i < parts.length; i++) {
                        if (obj === null || typeof obj !== 'object' || typeof obj[parts[i]] === 'undefined') {
                            throw 'Required field not found: ' + path;
                        }
                        obj = obj[parts[i]];
                    }
                    return obj;
                },
            
                safeField: function (obj, path) {
                    try {
                        return AWS.getField(obj, path);
                    } catch (_) {
                        return null;
                    }
                },
            
                getRoleBaseCredentials: function () {
                    AWS.params.auth_type = 'role_base';
            
                    var req = new HttpRequest();
                    req.addHeader('X-aws-ec2-metadata-token-ttl-seconds: 21600');
            
                    var token = req.put(AWS.metadata + 'api/token');
                    if (req.getStatus() !== 200 || !token) {
                        throw 'IMDSv2 token fetch failed.';
                    }
            
                    req.addHeader('X-aws-ec2-metadata-token: ' + token);
            
                    var roleName = req.get(AWS.metadata + 'meta-data/iam/security-credentials');
                    var creds = JSON.parse(req.get(AWS.metadata + 'meta-data/iam/security-credentials/' + roleName));
            
                    AWS.params.AccessKeyId = creds.AccessKeyId;
                    AWS.params.SecretAccessKey = creds.SecretAccessKey;
                    AWS.params.Token = creds.Token;
                },
            
                setParams: function (params) {
                    AWS.params.proxy = params.proxy;
            
                    if (params.auth_type === 'role_base') {
                        AWS.getRoleBaseCredentials();
                    } else {
                        AWS.params.AccessKeyId = params.AccessKeyId;
                        AWS.params.SecretAccessKey = params.SecretAccessKey;
                    }
            
                    AWS.params.describe_region = params.describe_region;
                    AWS.params.region_match = params.region_match;
                    AWS.params.region_not_match = params.region_not_match;
                },
            
                sign: function (key, msg) {
                    var hex = hmac('sha256', key, msg);
                    var out = new Int8Array(hex.length / 2);
                    for (var i = 0; i < hex.length; i += 2) {
                        out[i / 2] = parseInt(hex.substring(i, i + 2), 16);
                    }
                    return out;
                },
            
                prepareParams: function (params) {
                    var out = [];
                    var keys = Object.keys(params).sort();
                    for (var i = 0; i < keys.length; i++) {
                        out.push(keys[i] + '=' + encodeURIComponent(params[keys[i]]));
                    }
                    return out.join('&');
                },
            
                request: function (method, region, service, params) {
                    var req = new HttpRequest();
            
                    var now = new Date();
                    var amzdate = now.toISOString().replace(/\.\d+Z/, 'Z').replace(/[-:]/g, '');
                    var date = amzdate.substring(0, 8);
            
                    var host = service + '.' + region + '.amazonaws.com';
            
                    var canonical_headers =
                        'host:' + host + '\n' +
                        'x-amz-date:' + amzdate + '\n';
            
                    var signed_headers = 'host;x-amz-date';
                    var canonical_request =
                        method + '\n/\n' +
                        params + '\n' +
                        canonical_headers + '\n' +
                        signed_headers + '\n' +
                        sha256('');
            
                    var scope = date + '/' + region + '/' + service + '/aws4_request';
                    var string_to_sign =
                        'AWS4-HMAC-SHA256\n' +
                        amzdate + '\n' +
                        scope + '\n' +
                        sha256(canonical_request);
            
                    var key = AWS.sign('AWS4' + AWS.params.SecretAccessKey, date);
                    key = AWS.sign(key, region);
                    key = AWS.sign(key, service);
                    key = AWS.sign(key, 'aws4_request');
            
                    var signature = hmac('sha256', key, string_to_sign);
            
                    req.addHeader('x-amz-date: ' + amzdate);
                    req.addHeader('Authorization: AWS4-HMAC-SHA256 Credential=' +
                        AWS.params.AccessKeyId + '/' + scope +
                        ', SignedHeaders=' + signed_headers +
                        ', Signature=' + signature);
            
                    if (AWS.params.Token) {
                        req.addHeader('X-Amz-Security-Token: ' + AWS.params.Token);
                    }
            
                    var url = 'https://' + host + '/?' + params;
            
                    var body = req.get(url);
                    var status = req.getStatus();
            
                    if (status !== 200) {
                        throw 'HTTP ' + status + ': ' + body;
                    }
            
                    try {
                        return JSON.parse(body);
                    } catch (e) {
                        return JSON.parse(XML.toJson(body));
                    }
                },
            
                listRegions: function () {
                    var payload = {
                        Action: 'DescribeRegions',
                        Version: '2016-11-15'
                    };
            
                    var res = AWS.request(
                        'GET',
                        AWS.params.describe_region,
                        'ec2',
                        AWS.prepareParams(payload)
                    );
            
                    var regions = AWS.safeField(res, 'DescribeRegionsResponse.regionInfo.item');
                    if (!regions) return [];
                    if (!Array.isArray(regions)) regions = [regions];
            
                    return regions;
                },
            
                listVPNs: function () {
                    var lld = [];
                    var regions = AWS.listRegions();
            
                    regions.forEach(function (r) {
                        var regionName = AWS.getField(r, 'regionName');
            
                        if (regionName.match(AWS.params.region_match) === null ||
                            regionName.match(AWS.params.region_not_match) !== null)
                            return;
            
                        var payload = {
                            Action: 'DescribeVpnConnections',
                            Version: '2016-11-15'
                        };
            
                        var res;
                        try {
                            res = AWS.request('GET', regionName, 'ec2', AWS.prepareParams(payload));
                        } catch (e) {
                            return;
                        }
            
                        var vpnSet = AWS.safeField(res, 'DescribeVpnConnectionsResponse.vpnConnectionSet');
                        if (!vpnSet) return;
            
                        var vpns = vpnSet.item;
                        if (!vpns) return;
            
                        if (!Array.isArray(vpns)) vpns = [vpns];
            
                        vpns.forEach(function (vpn) {
                            var id = AWS.safeField(vpn, 'vpnConnectionId') || 'unknown';
                            var state = AWS.safeField(vpn, 'state') || 'unknown';
            
                            // ----------------------
                            // GET VPN NAME (TagSet)
                            // ----------------------
                            var vpnName = "unknown";
                            var tags = AWS.safeField(vpn, 'tagSet.item');
                            if (tags) {
                                if (!Array.isArray(tags)) tags = [tags];
                                for (var t = 0; t < tags.length; t++) {
                                    var key = AWS.safeField(tags[t], 'key');
                                    if (key === 'Name') {
                                        vpnName = AWS.safeField(tags[t], 'value');
                                        break;
                                    }
                                }
                            }
            
                            // Tunnel status
                            var telemetry = AWS.safeField(vpn, 'vgwTelemetry.item') || [];
                            if (!Array.isArray(telemetry)) telemetry = [telemetry];
            
                            var t1 = telemetry[0] ? telemetry[0].status : 'UNKNOWN';
                            var t2 = telemetry[1] ? telemetry[1].status : 'UNKNOWN';
            
                            lld.push({
                                vpnId: id,
                                vpnName: vpnName,
                                vpnState: state,
                                vpnRegion: regionName,
                                tunnel1: t1,
                                tunnel2: t2
                            });
                        });
                    });
            
                    return lld;
                }
            };
            
            try {
                AWS.setParams(JSON.parse(value));
                return JSON.stringify(AWS.listVPNs());
            } catch (e) {
                return JSON.stringify([]);
            }
          timeout: '{$AWS.DATA.TIMEOUT}'
          parameters:
            - name: AccessKeyId
              value: '{$AWS.ACCESS.KEY.ID}'
            - name: auth_type
              value: '{$AWS.AUTH_TYPE}'
            - name: describe_region
              value: '{$AWS.DESCRIBE.REGION}'
            - name: metadata_auth
              value: '{$AWS.ASSUME.ROLE.AUTH.METADATA}'
            - name: proxy
              value: '{$AWS.PROXY}'
            - name: region_match
              value: '{$AWS.EC2.LLD.FILTER.REGION.MATCHES}'
            - name: region_not_match
              value: '{$AWS.EC2.LLD.FILTER.REGION.NOT_MATCHES}'
            - name: role_arn
              value: '{$AWS.ASSUME.ROLE.ARN}'
            - name: SecretAccessKey
              value: '{$AWS.SECRET.ACCESS.KEY}'
            - name: sts_region
              value: '{$AWS.STS.REGION}'
      discovery_rules:
        - uuid: ba4b14e7fe9946cd8cc75e9dc0e5577e
          name: 'VPN discovery'
          type: DEPENDENT
          key: aws.vpn.discovery
          delay: '0'
          filter:
            conditions:
              - macro: '{#VPNNAME}'
                value: '{$AWS.VPN.LLD.FILTER.NAME.MATCHES}'
                formulaid: A
              - macro: '{#VPNNAME}'
                value: '{$AWS.VPN.LLD.FILTER.NAME.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
                formulaid: B
          item_prototypes:
            - uuid: fbf49436520741938c4759549e21f69c
              name: '{#VPNNAME}-({#VPNID}) Status'
              type: DEPENDENT
              key: 'aws.vpn.livestatus[{#VPNID}]'
              delay: '0'
              valuemap:
                name: 'VPN status'
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - |
                      try {
                          // Extract all JSON objects inside full dataset
                          var matches = value.match(/\{[\s\S]*?\}/g);
                      
                          if (!matches) {
                              return "NOT_FOUND";
                          }
                      
                          var objects = [];
                      
                          matches.forEach(function(m) {
                              try {
                                  var obj = JSON.parse(m);
                                  objects.push(obj);
                              } catch (_) {
                                  // Skip invalid chunks
                              }
                          });
                      
                          var target = "{#VPNID}".trim();  // current VPN ID from LLD
                      
                          for (var i = 0; i < objects.length; i++) {
                              if (objects[i].vpnId === target) {
                                  // Return VPN STATE ONLY
                                  return objects[i].vpnState || "UNKNOWN";
                              }
                          }
                      
                          return "NOT_FOUND";
                      
                      } catch (e) {
                          return "ERROR: " + e.toString();
                      }
                - type: STR_REPLACE
                  parameters:
                    - available
                    - '200'
                - type: STR_REPLACE
                  parameters:
                    - deleted
                    - '404'
                - type: STR_REPLACE
                  parameters:
                    - UNKNOWN
                    - '-1'
              master_item:
                key: aws.get.vpn
              tags:
                - tag: vpnname
                  value: '{#VPNNAME}'
              trigger_prototypes:
                - uuid: 48cd416694e4421a9bb42e936b0c14f9
                  expression: 'last(/AWS VPN by HTTP/aws.vpn.livestatus[{#VPNID}],#3)<>200 and last(/AWS VPN by HTTP/aws.vpn.livestatus[{#VPNID}],#3)=404'
                  name: 'VPN is deleted : {#VPNNAME}-({#VPNID})'
                  priority: HIGH
                  manual_close: 'YES'
            - uuid: d153fcd9b9dc460ab2bc042adbe8e0ec
              name: 'get {#VPNNAME} Summary'
              type: DEPENDENT
              key: 'aws.vpn.summary[{#VPNID}]'
              delay: '0'
              value_type: TEXT
              trends: '0'
              status: DISABLED
              discover: NO_DISCOVER
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - |
                      try {
                          // Extract all JSON objects found in the text
                          var matches = value.match(/\{[\s\S]*?\}/g);
                      
                          if (!matches) {
                              return "NOT_FOUND";
                          }
                      
                          var objects = [];
                      
                          matches.forEach(function(m) {
                              try {
                                  var obj = JSON.parse(m);
                                  objects.push(obj);
                              } catch (e) {
                                  // skip invalid chunks silently
                              }
                          });
                      
                          var target = "{#VPNID}".trim();
                      
                          for (var i = 0; i < objects.length; i++) {
                              if (objects[i].vpnId === target) {
                                  return JSON.stringify(objects[i]);
                              }
                          }
                      
                          return "NOT_FOUND";
                      
                      } catch (e) {
                          return "ERROR: " + e.toString();
                      }
              master_item:
                key: aws.get.vpn
            - uuid: 7e89e5a412d045389ef96e90c76dd615
              name: '{#VPNNAME}-({#VPNID})-Tunnel-1 Status'
              type: DEPENDENT
              key: 'aws.vpn.tunnel1[{#VPNID}]'
              delay: '0'
              valuemap:
                name: 'VPN status'
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - |
                      try {
                          // Extract all JSON objects from the full input
                          var matches = value.match(/\{[\s\S]*?\}/g);
                      
                          if (!matches) {
                              return "NOT_FOUND";
                          }
                      
                          var objects = [];
                      
                          matches.forEach(function(m) {
                              try {
                                  var obj = JSON.parse(m);
                                  objects.push(obj);
                              } catch (e) {
                                  // ignore broken fragments
                              }
                          });
                      
                          var target = "{#VPNID}".trim();   // current VPN ID
                      
                          for (var i = 0; i < objects.length; i++) {
                              if (objects[i].vpnId === target) {
                                  // Return TUNNEL 1 ONLY
                                  return objects[i].tunnel1;
                              }
                          }
                      
                          return "NOT_FOUND";
                      
                      } catch (e) {
                          return "ERROR: " + e.toString();
                      }
                - type: STR_REPLACE
                  parameters:
                    - UP
                    - '1'
                - type: STR_REPLACE
                  parameters:
                    - DOWN
                    - '0'
                - type: STR_REPLACE
                  parameters:
                    - UNKNOWN
                    - '2'
              master_item:
                key: aws.get.vpn
              tags:
                - tag: vpnname
                  value: '{#VPNNAME}'
            - uuid: fe3c9a26dadb44a1bbdc8d2b1770e62f
              name: '{#VPNNAME}-({#VPNID})-Tunnel-2 Status'
              type: DEPENDENT
              key: 'aws.vpn.tunnel2[{#VPNID}]'
              delay: '0'
              valuemap:
                name: 'VPN status'
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - |
                      try {
                          // Extract all JSON objects from the full input
                          var matches = value.match(/\{[\s\S]*?\}/g);
                      
                          if (!matches) {
                              return "NOT_FOUND";
                          }
                      
                          var objects = [];
                      
                          matches.forEach(function(m) {
                              try {
                                  var obj = JSON.parse(m);
                                  objects.push(obj);
                              } catch (e) {
                                  // ignore broken fragments
                              }
                          });
                      
                          var target = "{#VPNID}".trim();   // current VPN ID
                      
                          for (var i = 0; i < objects.length; i++) {
                              if (objects[i].vpnId === target) {
                                  // Return TUNNEL 1 ONLY
                                  return objects[i].tunnel2;
                              }
                          }
                      
                          return "NOT_FOUND";
                      
                      } catch (e) {
                          return "ERROR: " + e.toString();
                      }
                - type: STR_REPLACE
                  parameters:
                    - UP
                    - '1'
                - type: STR_REPLACE
                  parameters:
                    - DOWN
                    - '0'
                - type: STR_REPLACE
                  parameters:
                    - UNKNOWN
                    - '2'
              master_item:
                key: aws.get.vpn
              tags:
                - tag: vpnname
                  value: '{#VPNNAME}'
          trigger_prototypes:
            - uuid: 59c808451c5b4826a0cb43f2fa3168ff
              expression: |
                (last(/AWS VPN by HTTP/aws.vpn.tunnel1[{#VPNID}],#3)<>1
                and last(/AWS VPN by HTTP/aws.vpn.tunnel2[{#VPNID}],#3)<>1)and last(/AWS VPN by HTTP/aws.vpn.livestatus[{#VPNID}],#3)=200
              name: 'VPN is down on: {#VPNNAME}-({#VPNID})'
              priority: HIGH
              tags:
                - tag: vpnname
                  value: '{#VPNNAME}'
          graph_prototypes:
            - uuid: a43fbd2028a3416891d06a14e3baf761
              name: 'VPN Availability Status {#VPNNAME}-({#VPNID})'
              graph_items:
                - drawtype: BOLD_LINE
                  color: FFCA28
                  calc_fnc: ALL
                  item:
                    host: 'AWS VPN by HTTP'
                    key: 'aws.vpn.livestatus[{#VPNID}]'
            - uuid: 294780cbfc3c48dfa4aaea4c43e34db7
              name: 'VPN Tunnel Status {#VPNNAME}-({#VPNID})'
              graph_items:
                - drawtype: BOLD_LINE
                  color: AB47BC
                  calc_fnc: MIN
                  item:
                    host: 'AWS VPN by HTTP'
                    key: 'aws.vpn.tunnel2[{#VPNID}]'
                - sortorder: '1'
                  drawtype: BOLD_LINE
                  color: 00FFFF
                  calc_fnc: MIN
                  item:
                    host: 'AWS VPN by HTTP'
                    key: 'aws.vpn.tunnel1[{#VPNID}]'
          master_item:
            key: aws.get.vpn
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  try {
                      var text = value.trim();
                  
                      // Match ANY JSON object inside input
                      var matches = text.match(/\{[\s\S]*?\}/g);
                  
                      if (!matches) {
                          return JSON.stringify([]);
                      }
                  
                      var merged = [];
                  
                      matches.forEach(function(objText) {
                          try {
                              var obj = JSON.parse(objText);
                              merged.push(obj);
                          } catch (e) {
                              // skip invalid JSON chunks
                          }
                      });
                  
                      // Build LLD array
                      var out = merged.map(function(v) {
                          return {
                              "{#VPNID}": v.vpnId,
                              "{#VPNNAME}": v.vpnName
                          };
                      });
                  
                      return JSON.stringify(out);
                  
                  } catch (err) {
                      return JSON.stringify({ "error": err.toString() });
                  }
      tags:
        - tag: class
          value: software
        - tag: target
          value: aws
      macros:
        - macro: '{$AWS.ACCESS.KEY.ID}'
          description: 'Access key ID.'
        - macro: '{$AWS.ASSUME.ROLE.ARN}'
          description: 'ARN assume role; add when using the `assume_role` authorization method.'
        - macro: '{$AWS.AUTH_TYPE}'
          value: access_key
          description: 'Authorization method. Possible values: `access_key`, `assume_role`, `role_base`.'
        - macro: '{$AWS.DATA.TIMEOUT}'
          value: 60s
          description: 'A response timeout for an API.'
        - macro: '{$AWS.DESCRIBE.REGION}'
          value: us-east-1
          description: 'Region used in POST request `DescribeRegions`.'
        - macro: '{$AWS.EC2.LLD.FILTER.NAME.MATCHES}'
          value: '.*'
          description: 'Filter of discoverable EC2 instances by namespace.'
        - macro: '{$AWS.EC2.LLD.FILTER.NAME.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'Filter to exclude discovered EC2 instances by namespace.'
        - macro: '{$AWS.EC2.LLD.FILTER.REGION.MATCHES}'
          value: '.*'
          description: 'Filter of discoverable EC2 instances by region.'
        - macro: '{$AWS.EC2.LLD.FILTER.REGION.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'Filter to exclude discovered EC2 instances by region.'
        - macro: '{$AWS.PROXY}'
          description: 'Sets HTTP proxy value. If this macro is empty then no proxy is used.'
        - macro: '{$AWS.REQUEST.REGION}'
          value: us-east-1
          description: 'Region used in GET request `ListBuckets`.'
        - macro: '{$AWS.STS.REGION}'
          value: us-east-1
          description: 'Region used in assume role request.'
        - macro: '{$AWS.VPN.LLD.FILTER.NAME.MATCHES}'
          value: '.*'
        - macro: '{$AWS.VPN.LLD.FILTER.NAME.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
      valuemaps:
        - uuid: 3b899ac6cc75413e8be2ed888e0f267e
          name: 'VPN status'
          mappings:
            - value: '0'
              newvalue: DOWN
            - value: '1'
              newvalue: UP
            - value: '-1'
              newvalue: UNKNOWN
            - value: '404'
              newvalue: Deleted
            - value: '200'
              newvalue: Available
