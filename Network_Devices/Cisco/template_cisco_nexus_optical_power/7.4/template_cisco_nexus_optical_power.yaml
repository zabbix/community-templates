zabbix_export:
  version: '7.2'
  template_groups:
    - uuid: 36bff6c29af64692839d077febfc7079
      name: 'Templates/Network devices'
  templates:
    - uuid: 6d2860a17a9d441e96ffb680e2f247ee
      template: 'Cisco Nexus Optical Power by SNMP'
      name: 'Cisco Nexus Optical Power by SNMP'
      description: |
        Template to discover Cisco Nexus SFP/SFP+ DOM optical RX/TX power
         and thresholds via SNMP (CISCO-ENTITY-SENSOR-MIB, ENTITY-MIB).
        Designed for  Cisco Nexus 9000 with entPhysicalName like:
          "Ethernet1/1 Lane 1 Transceiver  Receive Power Sensor"
          "Ethernet1/1 Lane 1 Transceiver Transmit Power  Sensor"
      groups:
        - name: 'Templates/Network devices'
      discovery_rules:
        - uuid: b9362c4c3c534af990fa7f2b7c2f6e10
          name: 'Optical RX power discovery'
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#SNMPVALUE},1.3.6.1.2.1.47.1.1.1.1.7]'
          key: optical.rx.discovery
          delay: 1h
          description: |
            Discover Cisco Nexus transceiver RX optical power sensors using ENTITY-MIB entPhysicalName.
            Matches entries like "Ethernet1/1 Lane 1 Transceiver Receive Power Sensor".
            Adds {#IFNAME} macro with interface name (e.g. "Ethernet1/1").
          item_prototypes:
            - uuid: 87b1210f2c6f4a7e9b0d9b1ce2f93203
              name: '{#IFNAME}: RX optical high alarm threshold'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.2.1.1.4.{#SNMPINDEX}.1'
              key: 'nexus.optical.rx.high_alarm[{#IFNAME}]'
              delay: 1h
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorThresholdValue (4 = high alarm) for RX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
                - tag: threshold
                  value: high_alarm
            - uuid: e15f82d246c042cda2b936c7a3c0f0fb
              name: '{#IFNAME}: RX optical high warning threshold'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.2.1.1.4.{#SNMPINDEX}.2'
              key: 'nexus.optical.rx.high_warn[{#IFNAME}]'
              delay: 1h
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorThresholdValue (2 = high warning) for RX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
                - tag: threshold
                  value: high_warn
            - uuid: 8ee3e14706a24bca92fc71f46f0f81da
              name: '{#IFNAME}: RX optical low alarm threshold'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.2.1.1.4.{#SNMPINDEX}.3'
              key: 'nexus.optical.rx.low_alarm[{#IFNAME}]'
              delay: 1h
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorThresholdValue (3 = low alarm) for RX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
                - tag: threshold
                  value: low_alarm
            - uuid: 0d6e14040b5d4c6a8d29855aec2b463f
              name: '{#IFNAME}: RX optical low warning threshold'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.2.1.1.4.{#SNMPINDEX}.4'
              key: 'nexus.optical.rx.low_warn[{#IFNAME}]'
              delay: 1h
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorThresholdValue (1 = low warning) for RX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
                - tag: threshold
                  value: low_warn
            - uuid: 4b7a2b9845e14a479c0a73e3c6bff3f9
              name: '{#IFNAME}: RX optical power'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.1.1.1.4.{#SNMPINDEX}'
              key: 'nexus.optical.rx.power[{#IFNAME}]'
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorValue for transceiver RX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
          trigger_prototypes:
            - uuid: 9a3f93a90e414f1c8a0baf05c5c99d8d
              expression: 'avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.high_alarm[{#IFNAME}])'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.high_alarm[{#IFNAME}])-1'
              name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: RX optical power above HIGH alarm threshold'
              event_name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: RX optical power is above high alarm: >{ITEM.VALUE} dBm'
              opdata: 'Current value: {ITEM.LASTVALUE}'
              priority: HIGH
              description: 'RX optical power is higher than device high-alarm threshold from CISCO-ENTITY-SENSOR-MIB.'
              tags:
                - tag: component
                  value: optical
                - tag: scope
                  value: performance
            - uuid: 7c4a4a2f2b504cbf93cf0f7cbad6df19
              expression: 'avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.low_alarm[{#IFNAME}])'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'max(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.low_alarm[{#IFNAME}])+1'
              name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: RX optical power below LOW alarm threshold'
              event_name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: RX optical power is below low alarm: <{ITEM.VALUE} dBm'
              opdata: 'Current value: {ITEM.LASTVALUE}'
              priority: HIGH
              description: 'RX optical power is lower (worse) than device low-alarm threshold from CISCO-ENTITY-SENSOR-MIB.'
              tags:
                - tag: component
                  value: optical
                - tag: scope
                  value: availability
                - tag: scope
                  value: performance
            - uuid: e9ddcbeed06e46ce943e053494f8b031
              expression: '(avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.low_alarm[{#IFNAME}])) or (avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.high_alarm[{#IFNAME}]))'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: '(max(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.low_alarm[{#IFNAME}])+1) and (min(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.high_alarm[{#IFNAME}])-1)'
              name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: RX optical power out of ALARM range'
              event_name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: RX optical power out of ALARM range: {ITEM.VALUE} dBm'
              opdata: 'Current value: {ITEM.LASTVALUE}'
              priority: HIGH
              description: 'RX optical power is outside device low/high alarm thresholds (CISCO-ENTITY-SENSOR-MIB).'
              tags:
                - tag: component
                  value: optical
                - tag: scope
                  value: performance
            - uuid: fb755d48851a4c2e8c61822e756df6f7
              expression: '(avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.low_warn[{#IFNAME}])) or (avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.high_warn[{#IFNAME}]))'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: '(max(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.low_warn[{#IFNAME}])+1) and (min(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.rx.high_warn[{#IFNAME}])-1)'
              name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: RX optical power out of WARNING range'
              event_name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: RX optical power out of WARNING range: {ITEM.VALUE} dBm'
              opdata: 'Current value: {ITEM.LASTVALUE}'
              priority: WARNING
              description: 'RX optical power is outside device low/high warning thresholds (CISCO-ENTITY-SENSOR-MIB).'
              tags:
                - tag: component
                  value: optical
                - tag: scope
                  value: performance
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  try {
                      var rows = JSON.parse(value);
                  } catch (e) {
                      throw "Failed  to parse JSON for optical RX discovery.";
                  }
                  var result = [];
                  for (var  i = 0; i < rows.length; i++) {
                      var row = rows[i];
                      var name =  row["{#SNMPVALUE}"];
                      if (typeof name !== 'string') {
                          continue;
                       }
                      if (name.indexOf("Transceiver") === -1 || name.indexOf(" Receive Power Sensor") === -1) {
                          continue;
                      }
                      var ifname  = name.split(" ")[0];
                      row["{#IFNAME}"] = ifname;
                      result.push(row);
                   }
                  return JSON.stringify(result);
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 4h
        - uuid: c7e9f2a37a2c4d47b1cf5e9d7050ee0d
          name: 'Optical TX power discovery'
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#SNMPVALUE},1.3.6.1.2.1.47.1.1.1.1.7]'
          key: optical.tx.discovery
          delay: 1h
          description: |
            Discover Cisco Nexus transceiver TX optical power sensors using ENTITY-MIB entPhysicalName.
            Matches entries like "Ethernet1/1 Lane 1 Transceiver Transmit Power Sensor".
            Adds {#IFNAME} macro with interface name (e.g. "Ethernet1/1").
          item_prototypes:
            - uuid: 6f99e488a1ea4b29bad9766ef88ec94d
              name: '{#IFNAME}: TX optical high alarm threshold'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.2.1.1.4.{#SNMPINDEX}.1'
              key: 'nexus.optical.tx.high_alarm[{#IFNAME}]'
              delay: 1h
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorThresholdValue (4 = high alarm) for TX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
                - tag: threshold
                  value: high_alarm
            - uuid: 3f2e6ab68f8446d39325847b43d58739
              name: '{#IFNAME}: TX optical high warning threshold'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.2.1.1.4.{#SNMPINDEX}.2'
              key: 'nexus.optical.tx.high_warn[{#IFNAME}]'
              delay: 1h
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorThresholdValue (2 = high warning) for TX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
                - tag: threshold
                  value: high_warn
            - uuid: 1dd1a3070e804a4b8d5c7d7e249e8eef
              name: '{#IFNAME}: TX optical low alarm threshold'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.2.1.1.4.{#SNMPINDEX}.3'
              key: 'nexus.optical.tx.low_alarm[{#IFNAME}]'
              delay: 1h
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorThresholdValue (3 = low alarm) for TX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
                - tag: threshold
                  value: low_alarm
            - uuid: 0c2f176d7f9b4c79b9908a7e5477fb1c
              name: '{#IFNAME}: TX optical low warning threshold'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.2.1.1.4.{#SNMPINDEX}.4'
              key: 'nexus.optical.tx.low_warn[{#IFNAME}]'
              delay: 1h
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorThresholdValue (1 = low warning) for TX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
                - tag: threshold
                  value: low_warn
            - uuid: f8e2a8e2ffb54e91af655fbd819ddda8
              name: '{#IFNAME}: TX optical power'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.4.1.9.9.91.1.1.1.1.4.{#SNMPINDEX}'
              key: 'nexus.optical.tx.power[{#IFNAME}]'
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              description: 'CISCO-ENTITY-SENSOR-MIB: entSensorValue for transceiver TX optical power.'
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              tags:
                - tag: component
                  value: optical
                - tag: interface
                  value: '{#IFNAME}'
          trigger_prototypes:
            - uuid: 7e4a4e850c404f62a3f4d86fd5c676d3
              expression: 'avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.high_alarm[{#IFNAME}])'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.high_alarm[{#IFNAME}])-1'
              name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: TX optical power above HIGH alarm threshold'
              event_name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: TX optical power is above high alarm: >{ITEM.VALUE} dBm'
              opdata: 'Current value: {ITEM.LASTVALUE}'
              priority: HIGH
              description: 'TX optical power is higher than device high-alarm threshold from CISCO-ENTITY-SENSOR-MIB.'
              tags:
                - tag: component
                  value: optical
                - tag: scope
                  value: performance
            - uuid: 04c9f4d39a0e4bf59c703e6cc9add7ce
              expression: 'avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.low_alarm[{#IFNAME}])'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'max(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.low_alarm[{#IFNAME}])+1'
              name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: TX optical power below LOW alarm threshold'
              event_name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: TX optical power is below low alarm: <{ITEM.VALUE} dBm'
              opdata: 'Current value: {ITEM.LASTVALUE}'
              priority: HIGH
              description: 'TX optical power is lower (worse) than device low-alarm threshold from CISCO-ENTITY-SENSOR-MIB.'
              tags:
                - tag: component
                  value: optical
                - tag: scope
                  value: availability
                - tag: scope
                  value: performance
            - uuid: 00cade8d972f4f0d9837e674128560f4
              expression: '(avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.low_alarm[{#IFNAME}])) or (avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.high_alarm[{#IFNAME}]))'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: '(max(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.low_alarm[{#IFNAME}])+1) and (min(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.high_alarm[{#IFNAME}])-1)'
              name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: TX optical power out of ALARM range'
              event_name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: TX optical power out of ALARM range: {ITEM.VALUE} dBm'
              opdata: 'Current value: {ITEM.LASTVALUE}'
              priority: HIGH
              description: 'TX optical power is outside device low/high alarm thresholds (CISCO-ENTITY-SENSOR-MIB).'
              tags:
                - tag: component
                  value: optical
                - tag: scope
                  value: performance
            - uuid: 2c5a053e34f0482f95fff3bfba970e2d
              expression: '(avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.low_warn[{#IFNAME}])) or (avg(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.high_warn[{#IFNAME}]))'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: '(max(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)>last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.low_warn[{#IFNAME}])+1) and (min(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.power[{#IFNAME}],5m)<last(/Cisco Nexus Optical Power by SNMP/nexus.optical.tx.high_warn[{#IFNAME}])-1)'
              name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: TX optical power out of WARNING range'
              event_name: 'Cisco Nexus Optical Power by SNMP: {#IFNAME}: TX optical power out of WARNING range: {ITEM.VALUE} dBm'
              opdata: 'Current value: {ITEM.LASTVALUE}'
              priority: WARNING
              description: 'TX optical power is outside device low/high warning thresholds (CISCO-ENTITY-SENSOR-MIB).'
              tags:
                - tag: component
                  value: optical
                - tag: scope
                  value: performance
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  try {
                      var rows = JSON.parse(value);
                  } catch (e) {
                      throw "Failed  to parse JSON for optical TX discovery.";
                  }
                  var result = [];
                  for (var  i = 0; i < rows.length; i++) {
                      var row = rows[i];
                      var name =  row["{#SNMPVALUE}"];
                      if (typeof name !== 'string') {
                          continue;
                       }
                      if (name.indexOf("Transceiver") === -1 || name.indexOf(" Transmit Power Sensor") === -1) {
                          continue;
                      }
                      var ifname  = name.split(" ")[0];
                      row["{#IFNAME}"] = ifname;
                      result.push(row);
                   }
                  return JSON.stringify(result);
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 4h
