<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export><version>5.0</version><date>2021-11-21T21:58:52Z</date><groups><group><name>Templates App</name></group></groups><templates><template><template>App Nutcracker</template><name>App Nutcracker</name><description>## Overview

Template for collecting [nutcracker (twemproxy)](https://github.com/twitter/twemproxy) metrics.


By default template use system.run to collect metrics from &lt;http://localhost:22222&gt; (can be altered via macro) via zabbix-agent, but it can be changed to userparameter or http agent if remote commands are forbidden.


Some of the features:


* Pool and server discovery.
* Single request for LLD and metrics.
* Minimum host dependencies - only curl needed if system.run used. No host dependencies with http agent.
* No host scripts, utilizing Zabbix features: dependent items and JavaScript preprocessing.


## Author

Oleg Morozov aka zigmund

</description><groups><group><name>Templates App</name></group></groups><applications><application><name>Nutcracker</name></application></applications><items><item><name>Nutcracker current connections</name><type>DEPENDENT</type><key>nutcracker[stats,curr_connections]</key><delay>0</delay><history>7d</history><trends>90d</trends><description>Number of all active connections (client + server)</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$.curr_connections</params></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item><item><name>Nutcracker connections per second</name><type>DEPENDENT</type><key>nutcracker[stats,total_connections]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><description>Number of new connections per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$.total_connections</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item><item><name>Number of nutcracker processes</name><type>ZABBIX_ACTIVE</type><key>proc.num[nutcracker]</key><history>0</history><trends>0</trends><applications><application><name>Nutcracker</name></application></applications><triggers><trigger><expression>{last()}=0</expression><name>Nutcracker is dead</name><priority>HIGH</priority></trigger></triggers></item><item><name>Nutcracker stats</name><type>ZABBIX_ACTIVE</type><key>system.run[curl -s {$NUTCRACKER_URL}]</key><history>0</history><trends>0</trends><value_type>TEXT</value_type><description>Nutcracker JSON stats</description><applications><application><name>Nutcracker</name></application></applications></item></items><discovery_rules><discovery_rule><name>Pool discovery</name><type>DEPENDENT</type><key>nutcracker[stats,pool_discovery]</key><delay>0</delay><lifetime>7d</lifetime><item_prototypes><item_prototype><name>Nutcracker pool {#POOL} client connections</name><type>DEPENDENT</type><key>nutcracker[stats,pools,{#POOL},client_connections]</key><delay>0</delay><history>7d</history><trends>90d</trends><description>Number of active client connections</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['client_connections']</params></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker pool {#POOL} client EOF per second</name><type>DEPENDENT</type><key>nutcracker[stats,pools,{#POOL},client_eof]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><description>Number of eof on client connections per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['client_eof']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker pool {#POOL} client errors per second</name><type>DEPENDENT</type><key>nutcracker[stats,pools,{#POOL},client_err]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><description>Number of errors on client connections per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['client_err']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker pool {#POOL} forward errors per second</name><type>DEPENDENT</type><key>nutcracker[stats,pools,{#POOL},forward_error]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><description>Number of forwarding errors per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['forward_error']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item><trigger_prototypes><trigger_prototype><expression>{last()}&gt;0</expression><name>Nutcracker pool {#POOL} forward errors</name><priority>AVERAGE</priority></trigger_prototype></trigger_prototypes></item_prototype><item_prototype><name>Nutcracker pool {#POOL} fragments per second</name><type>DEPENDENT</type><key>nutcracker[stats,pools,{#POOL},fragments]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><description>Number of fragments created from a multi-vector request per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['fragments']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker pool {#POOL} server ejects per second</name><type>DEPENDENT</type><key>nutcracker[stats,pools,{#POOL},server_ejects]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><description>Number of times backend server was ejected per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['server_ejects']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype></item_prototypes><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item><preprocessing><step><type>JAVASCRIPT</type><params>var stats = JSON.parse(value),
    pool_keys = Object.keys(stats),
    pools = [];

for(var i in pool_keys) {
    if(typeof stats[pool_keys[i]] === 'object') {
        pools.push({&quot;{#POOL}&quot;: pool_keys[i]});
    }
}

return JSON.stringify(pools)</params></step></preprocessing></discovery_rule><discovery_rule><name>Server discovery</name><type>DEPENDENT</type><key>nutcracker[stats,server_discovery]</key><delay>0</delay><lifetime>7d</lifetime><item_prototypes><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} incoming queue requests</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},in_queue]</key><delay>0</delay><history>7d</history><trends>90d</trends><units>B</units><description>Current number of requests in incoming queue</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['in_queue']</params></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} incoming queue bytes</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},in_queue_bytes]</key><delay>0</delay><history>7d</history><trends>90d</trends><units>B</units><description>Current number of bytes in incoming queue</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['in_queue_bytes']</params></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} outgoing queue requests</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},out_queue]</key><delay>0</delay><history>7d</history><trends>90d</trends><description>Current number of requests in outgoing queue</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['out_queue']</params></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} outgoing queue bytes</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},out_queue_bytes]</key><delay>0</delay><history>7d</history><trends>90d</trends><units>B</units><description>Current number of bytes in outgoing queue</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['out_queue_bytes']</params></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} requests per second</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},requests]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><units>rps</units><description>Number of requests per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['requests']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} request bytes per second</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},request_bytes]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><units>Bps</units><description>Number of request bytes per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['request_bytes']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} responses per second</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},responses]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><units>rps</units><description>Number of responses per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['responses']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} response bytes per second</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},response_bytes]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><units>Bps</units><description>Number of response bytes per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['response_bytes']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} connections</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},server_connections]</key><delay>0</delay><history>7d</history><trends>90d</trends><description>Number of active server connections</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['server_connections']</params></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} last ejection timestamp</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},server_ejected_at]</key><delay>0</delay><history>7d</history><trends>90d</trends><units>unixtime</units><description>Last time when server was ejected at</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['server_ejected_at']</params></step><step><type>MULTIPLIER</type><params>0.000001</params></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item><trigger_prototypes><trigger_prototype><expression>{change()}&gt;1</expression><name>Nutcracker server {#POOL}/{#SERVER} was ejected</name><priority>AVERAGE</priority></trigger_prototype></trigger_prototypes></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} EOF per second</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},server_eof]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><description>Number of eof on server connections per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['server_eof']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} errors per second</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},server_err]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><description>Number of errors on server connections per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['server_err']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item><trigger_prototypes><trigger_prototype><expression>{last()}&gt;0</expression><name>Nutcracker server {#POOL}/{#SERVER} errors</name><priority>AVERAGE</priority></trigger_prototype></trigger_prototypes></item_prototype><item_prototype><name>Nutcracker server {#POOL}/{#SERVER} timeouts per second</name><type>DEPENDENT</type><key>nutcracker[stats,servers,{#POOL},{#SERVER},server_timedout]</key><delay>0</delay><history>7d</history><trends>90d</trends><value_type>FLOAT</value_type><description>Number of timeouts on server connections per second</description><applications><application><name>Nutcracker</name></application></applications><preprocessing><step><type>JSONPATH</type><params>$['{#POOL}']['{#SERVER}']['server_timedout']</params></step><step><type>CHANGE_PER_SECOND</type><params/></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><params>10m</params></step></preprocessing><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item></item_prototype></item_prototypes><master_item><key>system.run[curl -s {$NUTCRACKER_URL}]</key></master_item><preprocessing><step><type>JAVASCRIPT</type><params>var stats = JSON.parse(value),
    pool_keys = Object.keys(stats),
    servers = [];

for(var i in pool_keys) {
    if(typeof stats[pool_keys[i]] === 'object') {
        var server_keys = Object.keys(stats[pool_keys[i]]);

        for(var j in server_keys) {
            if(typeof stats[pool_keys[i]][server_keys[j]] === 'object') {
                servers.push({&quot;{#POOL}&quot;: pool_keys[i], &quot;{#SERVER}&quot;: server_keys[j]});
            }
        }
    }
}

return JSON.stringify(servers)</params></step></preprocessing></discovery_rule></discovery_rules><macros><macro><macro>{$NUTCRACKER_URL}</macro><value>http://localhost:22222</value><description>Nutcracker stats URL</description></macro></macros></template></templates></zabbix_export>
